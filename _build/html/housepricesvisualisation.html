<!DOCTYPE html><html lang="en" class="light" style="scroll-padding:60px"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>House Prices - About Me</title><meta property="og:title" content="House Prices - About Me"/><meta name="generator" content="mystmd"/><meta name="keywords" content=""/><meta name="image" content="/build/EDADensityPlot-762c22be9aee1c62ccbfd91e164b194f.PNG"/><meta property="og:image" content="/build/EDADensityPlot-762c22be9aee1c62ccbfd91e164b194f.PNG"/><link rel="icon" href="/favicon.ico"/><link rel="stylesheet" href="/build/_assets/app-IVMJSATM.css"/><link rel="stylesheet" href="/build/_assets/thebe-core-C4ZDKLDU.css"/><link rel="stylesheet" href="/myst-theme.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jupyter-matplotlib@0.11.3/css/mpl_widget.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous"/></head><body class="m-0 transition-colors duration-500 bg-white dark:bg-stone-900"><div class="fixed top-1 left-1 h-[0px] w-[0px] focus-within:z-40 focus-within:h-auto focus-within:w-auto bg-white overflow-hidden focus-within:p-2 focus-within:ring-1" aria-label="skip to content options"><a href="#skip-to-frontmatter" class="block px-2 py-1 text-black underline">Skip to article frontmatter</a><a href="#skip-to-article" class="block px-2 py-1 text-black underline">Skip to article content</a></div><div class="bg-white/80 backdrop-blur dark:bg-stone-900/80 shadow dark:shadow-stone-700 p-3 md:px-8 fixed w-screen top-0 z-30 h-[60px]"><nav class="flex items-center justify-between flex-wrap max-w-[1440px] mx-auto"><div class="flex flex-row xl:min-w-[19.5rem] mr-2 sm:mr-7 justify-start items-center"><div class="block xl:hidden"><button class="flex items-center border-stone-400 text-stone-800 hover:text-stone-900 dark:text-stone-200 hover:dark:text-stone-100"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="2rem" height="2rem" class="m-1"><path fill-rule="evenodd" d="M3 6.75A.75.75 0 013.75 6h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 6.75zM3 12a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 12zm0 5.25a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75a.75.75 0 01-.75-.75z" clip-rule="evenodd"></path></svg><span class="sr-only">Open Menu</span></button></div><a class="flex items-center ml-3 dark:text-white w-fit md:ml-5 xl:ml-7" href="/"><span class="text-md sm:text-xl tracking-tight sm:mr-5">Dan Rooney</span></a></div><div class="flex items-center flex-grow w-auto"><div class="flex-grow hidden text-md lg:block"></div><div class="flex-grow block"></div><button class="theme rounded-full border border-stone-700 dark:border-white hover:bg-neutral-100 border-solid overflow-hidden text-stone-700 dark:text-white hover:text-stone-500 dark:hover:text-neutral-800 w-8 h-8 mx-3" title="Change theme to dark mode." aria-label="Change theme to dark mode."><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-full w-full p-0.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"></path></svg></button><div class="block sm:hidden"><div class="relative" data-headlessui-state=""><div><button class="flex text-sm bg-transparent rounded-full focus:outline-none" id="headlessui-menu-button-:Rciop:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open Menu</span><div class="flex items-center text-stone-200 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="2rem" height="2rem" class="p-1"><path fill-rule="evenodd" d="M10.5 6a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm0 6a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm0 6a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z" clip-rule="evenodd"></path></svg></div></button></div></div></div><div class="hidden sm:block"><a href="mailto:danjrooney@hotmail.com" target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 mx-1 mt-0 leading-none border rounded text-md border-stone-700 dark:border-white text-stone-700 dark:text-white hover:text-stone-500 dark:hover:text-neutral-800 hover:bg-neutral-100">Email</a><a href="https://uk.linkedin.com/in/danjrooney98" target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 mx-1 mt-0 leading-none border rounded text-md border-stone-700 dark:border-white text-stone-700 dark:text-white hover:text-stone-500 dark:hover:text-neutral-800 hover:bg-neutral-100">LinkedIn</a></div></div></nav></div><div class="fixed xl:article-grid grid-gap xl:w-screen xl:pointer-events-none overflow-auto max-xl:min-w-[300px] hidden z-10" style="top:60px"><div class="pointer-events-auto xl:col-margin-left flex-col overflow-hidden hidden xl:flex"><nav aria-label="Table of Contents" class="flex-grow overflow-y-auto transition-opacity mt-6 pb-3 ml-3 xl:ml-0 mr-3 max-w-[350px]"><div class="w-full px-1 dark:text-white"><a title="About Me" class="block break-words focus:outline outline-blue-200 outline-2 rounded p-2 my-1 rounded-lg hover:bg-slate-300/30 font-bold" href="/">About Me</a><div data-state="open" class="w-full"><div class="flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Projects" class="block break-words rounded py-2 grow font-semibold text-blue-800 dark:text-blue-200 cursor-pointer">Projects</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R2d8p:" aria-expanded="true" data-state="open"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 010 1.06l-7.5 7.5a.75.75 0 01-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 011.06-1.06l7.5 7.5z" clip-rule="evenodd"></path></svg></button></div><div data-state="open" id="radix-:R2d8p:" class="pl-3 pr-[2px] collapsible-content"><a title="House Prices" aria-current="page" class="block break-words focus:outline outline-blue-200 outline-2 rounded p-2 my-1 rounded-lg bg-blue-300/30 active" href="/housepricesvisualisation">House Prices</a></div></div></div></nav><div class="flex-none py-4 transition-all duration-700 translate-y-6 opacity-0"><a class="flex mx-auto text-gray-700 w-fit hover:text-blue-700 dark:text-gray-200 dark:hover:text-blue-400" href="https://mystmd.org/made-with-myst" target="_blank" rel="noreferrer"><svg style="width:24px;height:24px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" stroke="none"><g id="icon"><path fill="currentColor" d="M23.8,54.8v-3.6l4.7-0.8V17.5l-4.7-0.8V13H36l13.4,31.7h0.2l13-31.7h12.6v3.6l-4.7,0.8v32.9l4.7,0.8v3.6h-15
          v-3.6l4.9-0.8V20.8H65L51.4,53.3h-3.8l-14-32.5h-0.1l0.2,17.4v12.1l5,0.8v3.6H23.8z"></path><path fill="#F37726" d="M47,86.9c0-5.9-3.4-8.8-10.1-8.8h-8.4c-5.2,0-9.4-1.3-12.5-3.8c-3.1-2.5-5.4-6.2-6.8-11l4.8-1.6
          c1.8,5.6,6.4,8.6,13.8,8.8h9.2c6.4,0,10.8,2.5,13.1,7.5c2.3-5,6.7-7.5,13.1-7.5h8.4c7.8,0,12.7-2.9,14.6-8.7l4.8,1.6
          c-1.4,4.9-3.6,8.6-6.8,11.1c-3.1,2.5-7.3,3.7-12.4,3.8H63c-6.7,0-10,2.9-10,8.8"></path></g></svg><span class="self-center ml-2 text-sm">Made with MyST</span></a></div></div></div><article class="article content article-grid grid-gap" style="margin-top:60px"><main class="article-grid subgrid-gap col-screen"><div class="hidden"></div><div id="skip-to-frontmatter" aria-label="article frontmatter" class="pt-5 mb-8"><div class="flex items-center h-6 mt-3 mb-5 text-sm font-light"><div class="flex-grow"></div><a href="https://github.com/dannycmd" title="GitHub Repository: dannycmd" target="_blank" rel="noopener noreferrer" class="text-inherit hover:text-inherit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="1.25rem" height="1.25rem" class="inline-block mr-1 opacity-60 hover:opacity-100"><path d="M12 2.5c-5.4 0-9.8 4.4-9.8 9.7 0 4.3 2.8 8 6.7 9.2.5.1.7-.2.7-.5v-1.8c-2.4.5-3.1-.6-3.3-1.1-.1-.3-.6-1.1-1-1.4-.3-.2-.8-.6 0-.6s1.3.7 1.5 1c.9 1.5 2.3 1.1 2.8.8.1-.6.3-1.1.6-1.3-2.2-.2-4.4-1.1-4.4-4.8 0-1.1.4-1.9 1-2.6-.1-.2-.4-1.2.1-2.6 0 0 .8-.3 2.7 1 .8-.2 1.6-.3 2.4-.3.8 0 1.7.1 2.4.3 1.9-1.3 2.7-1 2.7-1 .5 1.3.2 2.3.1 2.6.6.7 1 1.5 1 2.6 0 3.7-2.3 4.6-4.4 4.8.4.3.7.9.7 1.8V21c0 .3.2.6.7.5 3.9-1.3 6.6-4.9 6.6-9.2 0-5.4-4.4-9.8-9.8-9.8z"></path></svg></a><div class="inline-block mr-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="1.25rem" height="1.25rem" class="inline-block"><path d="M20.2 1.7c0 .8-.5 1.4-1.3 1.5-.8 0-1.4-.5-1.5-1.3 0-.8.5-1.4 1.3-1.5.8-.1 1.5.5 1.5 1.3zM12 17.9c-3.7 0-7-1.3-8.7-3.3 1.8 4.8 7.1 7.3 11.9 5.5 2.5-.9 4.5-2.9 5.5-5.5-1.7 2-4.9 3.3-8.7 3.3zM12 5.1c3.7 0 7 1.3 8.7 3.3-1.8-4.8-7.1-7.3-11.9-5.5-2.5.9-4.5 2.9-5.5 5.5 1.7-2 5-3.3 8.7-3.3zM6.9 21.8c.1 1-.7 1.8-1.7 1.9-1 .1-1.8-.7-1.9-1.7 0-1 .7-1.8 1.7-1.9 1-.1 1.8.7 1.9 1.7zM3.7 4.6c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1c0 .5-.4 1-1 1z"></path></svg></div><div class="relative flex inline-block mx-1 grow-0" data-headlessui-state=""><button class="relative ml-2 -mr-1" id="headlessui-menu-button-:Rd4fop:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Downloads</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="1.25rem" height="1.25rem"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg></button></div></div><h1 class="mb-0">House Prices</h1></div><div class="block my-10 lg:sticky lg:top-0 lg:z-10 lg:h-0 lg:pt-0 lg:my-0 lg:ml-10 lg:col-margin-right" style="top:93px"><nav></nav></div><div class="sticky top-[60px] flex justify-end w-full z-20 pointer-events-none"><div class="flex p-1 m-1 space-x-1 border rounded-full shadow pointer-events-auto border-stone-300 bg-white/80 dark:bg-stone-900/80 backdrop-blur"><div class="rounded"><button class="flex text-center rounded-full cursor-pointer text-stone-800 dark:text-white hover:opacity-100 opacity-60" aria-label="start compute environment"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="inline-block w-6 h-6 align-top"><title>enable compute</title><path stroke-linecap="round" stroke-linejoin="round" d="M5.636 5.636a9 9 0 1012.728 0M12 3v9"></path></svg></button></div></div></div><div id="skip-to-article"></div><div id="VhiLXjs49I" class="relative group/block article-grid subgrid-gap col-screen"><p>This project involved building an interactive web app, using Shiny for Python, to display house prices in England and Wales, adding a Choropleth layer to visualise the differences by region. The aim was to demonstrate the Shiny software and investigate trends in house prices over time and across different regions of England and Wales. This notebook contains is analysis into the data and a walkthrough of how the app was built, but if you’d just like to view the app then use this link:</p><p><em><a target="_blank" href="https://drooney.shinyapps.io/housepricesvisualisation/" rel="noreferrer">House Prices Visualisation</a></em></p><h2 id="about-the-data" class="relative group"><span class="heading-text">About the data</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#about-the-data" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>For this project I used the Price Paid Data published monthly by the UK government, which tracks property sales in England and Wales submitted to HM Land Registry for registration. The dataset contains single residential properties sold for value since 1995, and since 2013 includes transfers under power of sale/repossessions, buy-to-lets (where identifiable by Mortgage type) and transfers to non-private individuals. This data is also used by property websites such as Zoopla and Rightmove to allow users to track property prices.</p><p>The Price Paid Data includes information on all residential property sales in England and Wales that are sold for value and are lodged with us for registration. It excludes:</p><ul><li>sales that have not been lodged with HM Land Registry</li><li>sales that were not for value</li><li>transfers, conveyances, assignments or leases at a premium with nominal rent, which are:</li><li>‘Right to buy’ sales at a discount</li><li>subject to an existing mortgage</li><li>to effect the sale of a share in a property, for example, a transfer between parties on divorce</li><li>by way of a gift</li><li>under a compulsory purchase order</li><li>under a court order</li><li>to Trustees appointed under Deed of appointment</li><li>Vesting Deeds Transmissions or Assents of more than one property</li></ul><h2 id="initial-planning" class="relative group"><span class="heading-text">Initial planning</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#initial-planning" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><ul><li>What granularity to use? e.g. county, town, postcode<ul><li>The dataset contains the postcode of each property, and every postcode has a clearly defined area, which should be available online</li><li>The whole postcode is likely too granular - using the area code or district code should be a good compromise</li></ul></li><li>How to aggregate price paid by area?<ul><li>Allow user to choose which statistic to show on the map</li><li>Could also compare these summary statistics between points in time, which would highlight the areas which have seen the greatest changes in price over time</li><li>Will need to look at the distributions of house price to determine the summary statistics that will be suitable</li></ul></li></ul><h2 id="preparing-the-data" class="relative group"><span class="heading-text">Preparing the data</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#preparing-the-data" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>Loading the CSV file into a MySQL database:</p><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm bg-stone-200/10"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-sql" style="white-space:pre">DROP DATABASE IF EXISTS `houseprices`;
CREATE DATABASE `houseprices`;
USE `houseprices`;

CREATE TABLE `pricePaid` (
`unique_id` VARCHAR(100),
`price_paid` DECIMAL,
`deed_date` DATE,
`postcode` VARCHAR(8),
`property_type` VARCHAR(1),
`new_build` VARCHAR(1),
`estate_type` VARCHAR(1),
`saon` VARCHAR(50),
`paon` VARCHAR(50),
`street` VARCHAR(50),
`locality` VARCHAR(50),
`town` VARCHAR(50),
`district` VARCHAR(50),
`county` VARCHAR(50),
`transaction_category` VARCHAR(1),
`linked_data_uri` VARCHAR(1),
PRIMARY KEY (unique_id)
);

SET GLOBAL local_infile=ON;
SET autocommit=0;
SET unique_checks=1;
SET foreign_key_checks=0;

LOAD DATA LOW_PRIORITY 
LOCAL INFILE &#x27;Path/To/Project/pricepaid.csv&#x27;
INTO TABLE pricePaid 
CHARACTER SET armscii8
FIELDS TERMINATED BY &#x27;,&#x27;
ENCLOSED BY &#x27;&quot;&#x27;
LINES TERMINATED BY &#x27;\n&#x27; 
(`unique_id`,`price_paid`,`deed_date`,`postcode`,`property_type`,`new_build`,`estate_type`,`saon`,`paon`,`street`,`locality`,`town`,`district`,`county`,`transaction_category`,`linked_data_uri`);</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div></div><div id="fqo7kSOpfU" class="relative group/block article-grid subgrid-gap col-screen"><p>I had originally planned to use the full dataset in my Shiny app, however the full table is ~5GB in size with ~29m rows. For EDA purposes I am taking a sample of the data so that I can easily load the data into memory in Python. Taking a simple random sample of the data would mean that the number of samples from each area would be proportional to the population of that area, so to ensure that each area had an equal number of samples I would use stratified sampling instead.</p><p>I needed to choose a level of granularity to which to stratify the data. A UK postcode is made up of 2 parts, the outward code (first part) and inward code (second part), separated by a space. The outward code consists of the postcode area (either 1 or 2 letters) followed by the postcode district (usually 1 or 2 digits). For example, in the postcode PO16 7GZ, PO16 is the outward code (or outcode), PO is the area and 16 is the district.</p><p>OutCode was added as a generated column to the pricePaid table, along with a Year column and a YearBin column.</p><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm bg-stone-200/10"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-sql" style="white-space:pre">ALTER TABLE pricePaid ADD COLUMN OutCode VARCHAR(4) GENERATED ALWAYS AS substr(postcode, 1, locate(&#x27; &#x27;, postcode) - 1) STORED;
ALTER TABLE pricePaid ADD COLUMN Year INT GENERATED ALWAYS AS year(cast(deed_date as date)) STORED;
ALTER TABLE pricePaid ADD COLUMN YearBin VARCHAR(4) GENERATED ALWAYS AS case when (Year &lt; 2005) then &#x27;1995 - 2004&#x27; when (Year &lt; 2015) then &#x27;2005 - 2014&#x27; else &#x27;2015 +&#x27; end STORED;</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div></div><div id="MlEgmqrS2t" class="relative group/block article-grid subgrid-gap col-screen"><p>Creating an index on Outcode and YearBin to speed up the stratified sample query.</p><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm bg-stone-200/10"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-sql" style="white-space:pre">CREATE INDEX OutcodeYearBinIndex ON pricepaid (Outcode, YearBin);</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><p>Taking a stratified sample of 100 observations for each distinct OutCode and YearBin. This is to be used for EDA.</p><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm bg-stone-200/10"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-sql" style="white-space:pre">SELECT t.* FROM
(SELECT pp.*, ROW_NUMBER() OVER (PARTITION BY OutCode, YearBin ORDER BY RAND()) AS SeqNum
FROM pricePaid pp) t
WHERE t.SeqNum &lt;= 100
INTO LOCAL OUTFILE &#x27;/Path/To/Project/pricepaidsample.csv&#x27;
FIELDS TERMINATED BY &#x27;,&#x27;
ENCLOSED BY &#x27;&quot;&#x27;
LINES TERMINATED BY &#x27;\n&#x27;;</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div></div><div id="xf5ff78Okl" class="relative group/block article-grid subgrid-gap col-screen"><h2 id="exploratory-data-analysis" class="relative group"><span class="heading-text">Exploratory data analysis</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#exploratory-data-analysis" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>Importing the sample into Python and creating a density plot of all house prices:</p></div><div id="KNdR6ESvyA" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">from pathlib import Path
import os
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np

### Load data
appDir = Path(os.path.abspath(&#x27;&#x27;))
dataset = pd.read_csv(appDir / &quot;pricepaidsample.csv&quot;, delimiter=&#x27;\t&#x27;, header=0, encoding=&quot;utf-8&quot;)
# remove missing postcodes and price paid values of zero
dataset = dataset[~((dataset[&#x27;postcode&#x27;].isnull()) | (dataset[&#x27;price_paid&#x27;] == 0))]
dataset[&#x27;price_paid_mil&#x27;] = dataset[&#x27;price_paid&#x27;] / 1000000

# density plot of price paid
fig, ax = plt.subplots()
sns.kdeplot(df[&#x27;price_paid_mil&#x27;])
ax.set_xlabel(&#x27;Price Paid (£m)&#x27;)
ax.set_xlim(left=-5)
ax.set_ylim(bottom=-0.00005)
ax.set_title(&#x27;Density Plot of Price Paid Sample (£m)&#x27;)
ax.tick_params(bottom=True, left=True)
plt.show()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="uzO67DcAWn1LCX7hAiNoJ" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="kzu1gQYr6N" class="relative group/block article-grid subgrid-gap col-screen"><img id="v8FVrwomhl" style="margin:0 auto" src="/build/EDADensityPlot-762c22be9aee1c62ccbfd91e164b194f.PNG" alt="EDADensityPlot" data-canonical-url="../images/EDADensityPlot.PNG"/><p>This distribution is heavily right skewed due to some houses selling for 100s of millions. Looking at the summary statistics for the dataset indicates that the vast majority of price_paid values are less than £1m, so filtering out values greater than this should give a better view of the distribution.</p></div><div id="TqGhmwtdtT" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">dataset.describe()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="RjaJ2RXcFktmfHzlVl3fY" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="kOCc02TyLN" class="relative group/block article-grid subgrid-gap col-screen"><img id="P5GhMjyovK" style="margin:0 auto" src="/build/summarystats-e5b0c758566309021415e53a562126ef.PNG" alt="summarystats" data-canonical-url="../images/summarystats.PNG"/><p>Applying this &lt;= £1m filter and also splitting the data by region to produce a ridge plot so that we compare the distributions by region:</p></div><div id="EBveHaUdae" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">### postcode area to region lookup
outcodeRegion = pd.read_csv(appDir / &quot;postcode_region_lookup.csv&quot;)
outcodeRegion[&#x27;Area&#x27;] = outcodeRegion[&#x27;Postcode prefix&#x27;]
dataset[&#x27;Area&#x27;] = dataset[&#x27;Outcode&#x27;].replace(&#x27;\d+&#x27;, &#x27;&#x27;, regex=True)
df = pd.merge(dataset, outcodeRegion, on=&quot;Area&quot;, how=&quot;left&quot;)

# filtering data for house prices &lt;= £1m
df_filtered = df[df[&#x27;price_paid_mil&#x27;] &lt;= 1]

# ridge plot of log price paid by region
def ridgePlot(df, xVar, groups):
    sns.set_theme(style=&quot;white&quot;, rc={&quot;axes.facecolor&quot;: (0, 0, 0, 0)})
    palette = sns.color_palette(&quot;Set2&quot;, 12)
    g = sns.FacetGrid(df, palette=palette, row=groups, hue=groups, aspect=9, height=1.2)
    g.map_dataframe(sns.kdeplot, x=xVar, fill=True, alpha=1)
    g.map_dataframe(sns.kdeplot, x=xVar, color=&#x27;black&#x27;)

    def label(x, color, label):
        ax = plt.gca()
        ax.text(0, .2, label, color=&#x27;black&#x27;, fontsize=13,
                ha=&quot;left&quot;, va=&quot;center&quot;, transform=ax.transAxes)

    g.map(label, groups)
    g.figure.subplots_adjust(hspace=-.5)
    g.set_titles(&quot;&quot;)
    g.set(yticks=[], xlabel=&quot;Price Paid £m&quot;, ylabel=&quot;&quot;)
    g.despine(left=True)

ridgePlot(df_filtered, &quot;price_paid_mil&quot;, &quot;UK region&quot;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="j1gDA8eNsmiWNdNm2swCC" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="L8OwYcnMNr" class="relative group/block article-grid subgrid-gap col-screen"><img id="uWrSvMHPM0" style="margin:0 auto" src="/build/EDARidgePlot-3b1de7079af22de03c167b3104d4bdd5.PNG" alt="EDARidgePlot" data-canonical-url="../images/EDARidgePlot.PNG"/><p>This shows that all regions have the same type of distribution - though some regions, such as London and South East, are more heavily right skewed. Next I am trying to see if I can fit this distribution to a known distribution, specifically the lognormal distribution (a distribution is lognormal if its log follow a normal distribution):</p></div><div id="RoaVjNRYPO" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">import scipy
import numpy as np

### determining the distribution type
shape, location, scale = scipy.stats.lognorm.fit(df_filtered[&#x27;price_paid_mil&#x27;])
mu, sigma = np.log(scale), shape
xmin, xmax = np.min(df_filtered[&#x27;price_paid_mil&#x27;]), np.max(df_filtered[&#x27;price_paid_mil&#x27;])
x = np.linspace(xmin, xmax, 1000)

fig, ax = plt.subplots()
plt.plot(x, scipy.stats.lognorm.pdf(x, shape, location, scale), label=&quot;Lognormal&quot;)
sns.kdeplot(df_filtered, x=&quot;price_paid_mil&quot;, label=&quot;Density Plot&quot;)
ax.set_xlabel(&#x27;Price Paid (£m)&#x27;)
ax.set_ylim(bottom=-0.1)
ax.set_title(&#x27;Price Paid Sample (£m) - Density Plot vs Fitted Lognormal Distribution&#x27;)
ax.tick_params(bottom=True, left=True)
plt.legend(facecolor=&#x27;white&#x27;)
plt.show()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="x9WrM2kxdUQVPOBeV_usQ" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="QgwfKdJL0c" class="relative group/block article-grid subgrid-gap col-screen"><img id="dDsu4ffJHt" style="margin:0 auto" src="/build/EDAFitToLognormal-c7c81da0dbd92113709c5de0d5d269c8.PNG" alt="EDAFitToLognormal" data-canonical-url="../images/EDAFitToLognormal.PNG"/><p>Except for some of the data points at the peak of the curve, this appears to give a very close fit. We could conclude from this that the overall distribution of house prices less than £1m closely fits a lognormal distribution. We can check this with a QQ plot of the log of house price against a reference normal distribution:</p></div><div id="PcAyxV7U6p" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">import statsmodels.api as sm

df_filtered[&#x27;log_price_paid_mil&#x27;] = np.log(df_filtered[&#x27;price_paid_mil&#x27;])

### QQ plot
fig, ax = plt.subplots(2, 1)
sm.qqplot(data=df_filtered[&#x27;log_price_paid_mil&#x27;], line=&#x27;s&#x27;, ax=ax[0])
sns.kdeplot(df_filtered[&#x27;log_price_paid_mil&#x27;], ax=ax[1])
plt.show()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="mtVYtjiDZ0y1av_tUpyAh" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="E5HbDqW7eY" class="relative group/block article-grid subgrid-gap col-screen"><img id="HCeJDz9LTh" style="margin:0 auto" src="/build/EDAQQPlot-c692caa2546662c6c49fd8555e487010.PNG" alt="EDAQQPlot" data-canonical-url="../images/EDAQQPlot.PNG"/><p>The log of price paid closely matches the normal distribution in the centre, but deviates significantly in the tails, suggesting that the data does not actually quite follow a lognormal distribution. Therefore, instead of using the lognormal parameters as summary statistics in my visualisation to describe the data, non-parametric statistics such as the median and interquartile range (IQR) will be more appropriate.</p></div><div id="r9lEBb0bVc" class="relative group/block article-grid subgrid-gap col-screen"><h2 id="transforming-and-aggregating-the-data" class="relative group"><span class="heading-text">Transforming and aggregating the data</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#transforming-and-aggregating-the-data" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>Before the data can be used in the Shiny app, it needs to be aggregated. Doing this aggregation outside the Shiny app and reading the aggregated data directly instead greatly improves the performance of the app, hence why I’m using SQL below.</p><p>I’m choosing to use Outcode as the area to aggregate by, since these areas on the map should granular enough to give a detailed spatial distribution on the map, and each outcode should be of a similar size. The summary statistics are chosen taking into consideration the highly right skewed shape of the pseudo-lognormal distribution - the median will be a better estimate of the average value than the arithmetic mean (because it’s not affected by outliers), and the IQR will be a better estimate of spread for the same reason. I am also including skew since we know that the distributions of some regions are more heavily skewed than others.</p><p>We are also aggregating by YearBin so that we will be able to compare the data between different time periods.</p><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm bg-stone-200/10"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-sql" style="white-space:pre">CREATE TABLE minMaxMeanCountStddev AS
SELECT Outcode, YearBin
,MIN(price_paid) AS min
,MAX(price_paid) AS max
,AVG(price_paid) AS mean
,STD(price_paid) AS stddev
,COUNT(*) AS count
FROM pricePaid
GROUP BY Outcode, YearBin;

CREATE TABLE skew AS
SELECT t1.Outcode, t1.YearBin
,SUM(POWER((price_paid - t1.mean), 3) / ((t1.count - 1) * POWER(t1.stddev, 3))) as skew
FROM minMaxMeanCountStddev t1
INNER JOIN pricePaid pp on t1.Outcode = pp.Outcode and t1.YearBin = pp.YearBin
WHERE t1.count &lt;&gt; 1 and t1.stddev &lt;&gt; 0 --avoiding division by zero error
GROUP BY t1.Outcode, t1.YearBin;

--this method of calculating the quartiles will not be entirely accurate if the actual quartile falls between 2 values, but it is close enough for this purpose
CREATE TABLE quartiles AS
SELECT Outcode, YearBin, QUARTILE, MAX(price_paid) AS Q1_Q2_Q3
FROM 
(SELECT Outcode, YearBin, price_paid, NTILE(4) OVER (PARTITION BY Outcode, YearBin ORDER BY price_paid) AS QUARTILE
FROM pricepaid) S
WHERE QUARTILE &lt;= 3
GROUP BY Outcode, YearBin, QUARTILE;

CREATE TABLE quartilesTransposed as 
SELECT s.Outcode, s.YearBin
,SUM(s.lowerQuartile) AS lowerQuartile
,SUM(s.median) AS median
,SUM(s.upperQuartile) AS upperQuartile
FROM
(SELECT Outcode, YearBin
,CASE WHEN Quartile = 1 THEN Q1_Q2_Q3 ELSE 0 END AS lowerQuartile
,CASE WHEN Quartile = 2 THEN Q1_Q2_Q3 ELSE 0 END AS median
,CASE WHEN Quartile = 3 THEN Q1_Q2_Q3 ELSE 0 END AS upperQuartile
FROM quartiles) s
GROUP BY s.Outcode, s.YearBin;

SELECT t1.*, t2.median, t2.lowerQuartile, t2.upperQuartile, t3.skew
, t1.max - t1.min AS range_, t2.upperQuartile - t2.lowerQuartile AS IQR
FROM minMaxMeanCountStddev t1
INNER JOIN quartilesTransposed t2 on t1.Outcode = t2.Outcode and t1.YearBin = t2.YearBin
INNER JOIN skew t3 on t1.Outcode = t3.Outcode and t1.YearBin = t3.YearBin
INTO LOCAL OUTFILE &#x27;/Path/To/Project/summary.csv&#x27;
FIELDS TERMINATED BY &#x27;,&#x27;
ENCLOSED BY &#x27;&quot;&#x27;
LINES TERMINATED BY &#x27;\n&#x27;;</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div></div><div id="c3Q8u29nHk" class="relative group/block article-grid subgrid-gap col-screen"><p>Now we can load the aggregated data into Python and additionally prepare a GeoJSON file, which is needed so that the Shiny app knows where the boundaries of each Outcode area are.</p></div><div id="wuReO1pynu" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">from pathlib import Path
import pandas as pd

### Load aggregated data
appDir = Path(__file__).parent
summary = pd.read_csv(appDir / &#x27;app/summary.csv&#x27;, encoding=&#x27;utf-8&#x27;, delimiter=&#x27;,&#x27;)
summary = summary[(~summary[&#x27;Outcode&#x27;].isnull())]
summary = summary.rename(columns={&quot;range_&quot;: &quot;range&quot;})</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="Xl7BDUZ2SXGchzSnw84ZJ" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="wIRQZPSfTY" class="relative group/block article-grid subgrid-gap col-screen"><p>A folder containing a GeoJSON file with the polygon coordinates of each Outcode was downloaded online (<a target="_blank" href="https://github.com/mhl/postcodes-mapit" rel="noreferrer">https://<wbr/>github<wbr/>.com<wbr/>/mhl<wbr/>/postcodes<wbr/>-mapit</a>). This is combined into a single GeoJSON file:</p></div><div id="i61pr0ovzR" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">import json
import itertools

### Get polygon coordinates (GeoJSON) of each PostcodeArea
geojsonDir = appDir / &#x27;districts&#x27;
# combine all PostcodeArea datasets, one for each PostcodeArea
geojsonDict = {}
for file in geojsonDir.glob(&#x27;*.geojson&#x27;):
    with open(file, &#x27;r&#x27;) as f:
        geojsonDict[str(file).split(&#x27;\\&#x27;)[-1][:-8]] = json.load(f)
# add id string to link to summary data
for key in geojsonDict.keys():
    geojsonDict[key][&#x27;features&#x27;][0][&#x27;id&#x27;] = key
# changing format of geojsonDict to meet required format for Choropleth function
geojsonList = []
uniqueOutcodes = summary[&#x27;Outcode&#x27;].unique().tolist()
for outcode in geojsonDict.keys():
    features = geojsonDict[outcode][&#x27;features&#x27;]
    if outcode in uniqueOutcodes:
        geojsonList.append(features[0])
geojsonDict = {}
geojsonDict[&#x27;type&#x27;] = &#x27;FeatureCollection&#x27;
geojsonDict[&#x27;features&#x27;] = geojsonList

### make sure summary data has a row for every Outcode and YearBin - set aggregate values to null if missing
uniqueYearBins = summary[&#x27;YearBin&#x27;].unique().tolist()
crossJoin = list(itertools.product(uniqueOutcodes, uniqueYearBins))
crossJoin = pd.DataFrame(crossJoin, columns=[&quot;Outcode&quot;, &quot;YearBin&quot;])
summary = pd.merge(crossJoin, summary, how=&quot;left&quot;, on=[&quot;Outcode&quot;, &quot;YearBin&quot;])</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="W7r7KXfzHc1EyOGjv7fit" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="Y0jneY5WdD" class="relative group/block article-grid subgrid-gap col-screen"><p>As the final step in the data preparation, the GeoJSON file and summary dataset were exported to the folder so that they can be read into the Shiny app:</p></div><div id="LKz03N4TAf" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre"># export as geojson dictionary as json file
with open(appDir / &#x27;app/OutcodeCoordinates.json&#x27;, &#x27;w&#x27;) as fp:
    json.dump(geojsonDict, fp)

# export summary dataframe as csv
summary.to_csv(appDir / &#x27;app/summary.csv&#x27;, index=False)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="Whkz2DcYzN3ktYJmOLN2m" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="PD0VXMn6V0" class="relative group/block article-grid subgrid-gap col-screen"><h2 id="building-the-shiny-app" class="relative group"><span class="heading-text">Building the Shiny app</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#building-the-shiny-app" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="pu4gBLq6aH" class="relative group/block article-grid subgrid-gap col-screen"><p>The app.py program of the Shiny app consists of 3 main parts:</p><ul><li>importing the data</li><li>building the HTML interface</li><li>defining a server function</li></ul></div><div id="m1jWK3PnCH" class="relative group/block article-grid subgrid-gap col-screen"><h3 id="importing-the-data" class="relative group"><span class="heading-text">Importing the data</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#importing-the-data" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="Bar68M9S8U" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">from pathlib import Path
import os
import json
import pandas as pd
from ipyleaflet import Map, Choropleth
from shiny import App, Inputs, Outputs, Session, ui, reactive, render
from shinywidgets import output_widget, render_widget
from branca.colormap import linear

### Load data
appDir = Path(os.path.abspath(&#x27;&#x27;))
with open(appDir / &#x27;OutcodeCoordinates.json&#x27;, &#x27;r&#x27;) as f:
    outcodeCoordinates = json.load(f)
outcodes = [i[&#x27;id&#x27;] for i in outcodeCoordinates[&#x27;features&#x27;]]
summary = pd.read_csv(appDir / &#x27;summary.csv&#x27;, encoding=&#x27;utf-8&#x27;, delimiter=&#x27;,&#x27;)
summary = summary[(~summary[&#x27;Outcode&#x27;].isnull()) &amp; (summary[&#x27;Outcode&#x27;].isin(outcodes))]
summary = summary.rename(columns={&quot;range_&quot;: &quot;range&quot;})
yearBins = list(summary[&#x27;YearBin&#x27;].unique())</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="xJ96fL7tWL4oODj_JusYz" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="aKaOkmsZoz" class="relative group/block article-grid subgrid-gap col-screen"><h3 id="building-the-html-interface" class="relative group"><span class="heading-text">Building the HTML interface</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#building-the-html-interface" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="stXfbVEDiC" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre"># Nest Python functions to build an HTML interface
app_ui = ui.page_fillable( 
    # Layout the UI with Layout Functions
    # Add Inputs with ui.input_*() functions 
    # Add Outputs with ui.output_*() functions
    ui.layout_sidebar(
        ui.sidebar(
            ui.input_checkbox_group(&#x27;yearBin&#x27;, &quot;Time Period&quot;, yearBins),
            ui.input_select(&#x27;statistic&#x27;, &quot;House Price Summary Statistic&quot;, [&#x27;mean&#x27;, &#x27;median&#x27;, &#x27;min&#x27;, &#x27;max&#x27;, &#x27;IQR&#x27;, &#x27;range&#x27;, &#x27;skew&#x27;], selected=&#x27;median&#x27;, multiple=False),
            ui.input_switch(&quot;switch&quot;, &quot;Compare Summary Statistic between Time Periods&quot;, False)
        ),
        ui.card(
            ui.output_image(&quot;image&quot;, height=&#x27;10px&#x27;),
            output_widget(&quot;map&quot;, fill=True),
            full_screen=True,
            fill=True
        ),
        ui.card_footer(&quot;Contains HM Land Registry data © Crown copyright and database right 2021. This data is licensed under the Open Government Licence v3.0.&quot;),
        full_screen=True
    ),
    title=&quot;House Prices Visualisation&quot;
)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="u7owK-h4gmZ9CBPdd_Nmo" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="zy8dNXsNu0" class="relative group/block article-grid subgrid-gap col-screen"><p>This results in a HTML template that looks like this:</p><img id="jRyY0xYGE4" style="margin:0 auto" src="/build/HTMLTemplate-8d0c4305e9a1ca30330c8d39456bdeec.PNG" alt="HTMLTemplate" data-canonical-url="../images/HTMLTemplate.PNG"/></div><div id="YBWu24FFPZ" class="relative group/block article-grid subgrid-gap col-screen"><h3 id="defining-a-server-function" class="relative group"><span class="heading-text">Defining a server function</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#defining-a-server-function" title="Link to this Section" aria-label="Link to this Section">¶</a></h3><p>Within the server function, the createChoroData function is reactive and will be called every time one of the inputs to the app changes. The functions uses the user inputs to filter the dataset and return a dictionary containing a key for each Outcode and a value corresponding to the summary statistic.</p><p>The createChoroData function also contains logic for if more than one time period is selected - in this case the function will calculate the difference between the summary statistics of the earliest and latest time period selected.</p><p>The map function creates an ipyleaflet Map object and adds a Choropleth layer to it.</p></div><div id="YO1ieVFjWV" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre"># Define server
def server(input: Inputs, output: Outputs, session: Session):
    # add colour map image
    @render.image
    def image():
        img = {&quot;src&quot;: appDir / &quot;ColourMap.jpg&quot;, &quot;width&quot;: &quot;300px&quot;}  
        return img

    # function to filter the summary dataset and return a lookup dictionary with a key for each Outcode
    @reactive.calc
    def createChoroData():

        # select all time periods if none are selected
        if input.yearBin() == tuple():
            filter = yearBins
        else:
            filter = list(input.yearBin())

        # logic for comparing summary stastics between time periods
        if input.switch():
            minYearBin = filter[0]
            maxYearBin = filter[-1]
            dfMin = summary[summary[&#x27;YearBin&#x27;] == minYearBin][[&#x27;Outcode&#x27;, input.statistic()]]
            dfMax = summary[summary[&#x27;YearBin&#x27;] == maxYearBin][[&#x27;Outcode&#x27;, input.statistic()]]
            df = pd.merge(dfMin, dfMax, how=&quot;inner&quot;, on=&quot;Outcode&quot;)
            df[&#x27;diff&#x27;] = df[input.statistic() + &#x27;_y&#x27;] - df[input.statistic() + &#x27;_x&#x27;]
            df = df.set_index(&#x27;Outcode&#x27;)
            df[&#x27;decile&#x27;] = pd.qcut(df[&#x27;diff&#x27;], 10, labels=False)
            return df[&#x27;decile&#x27;].to_dict()                
        # if not comparing time periods then just show summary statistic
        else:
            df = summary[summary[&#x27;YearBin&#x27;].isin(filter)].set_index(&#x27;Outcode&#x27;)
            df[&#x27;decile&#x27;] = pd.qcut(df[input.statistic()], 10, labels=False)
            return df[&#x27;decile&#x27;].to_dict()

    ### For each output, define a function that generates the output
    @render_widget  
    def map():
        # create a Map object and add a Choropleth layer to it
        m = Map(center=(54.00366, -2.547855), zoom=5.5, zoom_snap=0.2, zoom_delta=0.2)

        try:
            layer = Choropleth(
                    geo_data=outcodeCoordinates,
                    choro_data=createChoroData(),
                    key_on=&#x27;id&#x27;,
                    colormap=linear.viridis,
                    border_color=&#x27;black&#x27;,
                    style={&#x27;fillOpacity&#x27;: 0.8, &#x27;dashArray&#x27;: &#x27;5, 5&#x27;}
                )
        except:
            raise IndexError(&quot;Must select more than one time period if comparing summary statistic between time periods.&quot;)

        m.add(layer)

        return m

# Call App() to combine app_ui and server() into an interactive app
app = App(app_ui, server)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="o6CuYK6iHi-qrYRSQDYF3" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="BpWxFl4NGq" class="relative group/block article-grid subgrid-gap col-screen"><h2 id="transforming-the-data-again" class="relative group"><span class="heading-text">Transforming the data (again)</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#transforming-the-data-again" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>The Shiny app is now working, however it is not very insightful because (except for a couple of areas in London) every area appears to be the same colour:</p><img id="Z73TdhIYzf" style="margin:0 auto" src="/build/MapNoTransformation-c1b1cddad762ed00490e0d614bd3ee85.PNG" alt="MapNoTransformation" data-canonical-url="../images/MapNoTransformation.PNG"/><p>The density plot below, of all of the house prices in the sample, shows what the problem is. The data is highly right skewed, and because the colour map works by assigning a different colour to each quantile, the majority of data has the same colour.</p></div><div id="Hwudyvu7bA" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">from pathlib import Path
import os
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
import statsmodels.api as sm

### Load data
appDir = Path(os.path.abspath(&#x27;&#x27;)).parent
summary = pd.read_csv(appDir / &#x27;app/summary.csv&#x27;, encoding=&#x27;utf-8&#x27;, delimiter=&#x27;,&#x27;)
summary = summary[(~summary[&#x27;Outcode&#x27;].isnull())]
summary = summary.rename(columns={&quot;range_&quot;: &quot;range&quot;})

fig, ax = plt.subplots(2, 1, figsize=(10,12))

summary[&#x27;median_mil&#x27;] = summary[&#x27;median&#x27;] / 1000000
summary[&#x27;log_median_mil&#x27;] = np.log(summary[&#x27;median_mil&#x27;])

fig, ax = plt.subplots(2, 1, figsize=(10, 12))
sns.kdeplot(data=summary, x=&#x27;median_mil&#x27;, ax=ax[0])
sm.qqplot(summary[&#x27;median_mil&#x27;], ax=ax[1])
ax[0].set_xlabel(&#x27;Price Paid Medians (£m)&#x27;)
ax[0].set_xlim(left=-5)
ax[0].set_ylim(bottom=-0.005)
ax[0].set_title(&#x27;Density Plot of Price Paid Sample Medians (£m)&#x27;)
ax[0].tick_params(bottom=True, left=True)
ax[1].set_title(&#x27;QQ Plot of Price Paid Sample Medians (£m)&#x27;)

plt.tight_layout()
plt.show()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="kfNEHgEgFyOO1N_TyjGMD" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="zztkLn9IZv" class="relative group/block article-grid subgrid-gap col-screen"><img id="QB27pxEHPY" style="margin:0 auto" src="/build/DensityPlot-d477947a2d64a092e2dae3758916715a.PNG" alt="DensityPlot" data-canonical-url="../images/DensityPlot.PNG"/></div><div id="svKsXiOTVT" class="relative group/block article-grid subgrid-gap col-screen"><p>To resolve this, the QuantileTransformer function from scikit-learn was used to mathematically transform the data to follow a more normal distribution. This is a non-parametric method that works by mapping each quantile of the input distribution onto those of the output distribution (in this case the normal distribution) and applying the required transformation to each quantile so that they match as closely as possible. This is often used to transform features for machine learning problems because certain machine learning algorithms cannot effectively deal with non-normal features.</p></div><div id="OBtCwPXpxn" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">from sklearn.preprocessing import QuantileTransformer

qt = QuantileTransformer(output_distribution=&#x27;normal&#x27;, random_state=0)
values = qt.fit_transform(np.array(list(summary[&#x27;median_mil&#x27;])).reshape(-1, 1)).flatten()

fig, ax = plt.subplots(2, 1, figsize=(10, 12))
sm.qqplot(data=np.array(values), ax=ax[1])
sns.kdeplot(data=values, ax=ax[0])
ax[0].set_xlabel(&#x27;Quantile Transformed Price Paid Medians (£m)&#x27;)
ax[0].set_xlim(left=-5)
ax[0].set_ylim(bottom=-0.005)
ax[0].set_title(&#x27;Density Plot of Quantile Transformed Price Paid Sample Medians (£m)&#x27;)
ax[0].tick_params(bottom=True, left=True)
ax[1].set_title(&#x27;QQ Plot of Quantile Transformed Price Paid Sample Medians (£m)&#x27;)

plt.tight_layout()
plt.show()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="C3h3eNqLtVqeVYpHxdEB1" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="Ahw0hKlWRw" class="relative group/block article-grid subgrid-gap col-screen"><img id="Oo6FNZNnlw" style="margin:0 auto" src="/build/DensityPlotQuantileT-776e83704f57253f71d44c2bfdd6b32f.PNG" alt="DensityPlotQuantileTransformed" data-canonical-url="../images/DensityPlotQuantileTransformed.PNG"/></div><div id="ODHiOk8bDa" class="relative group/block article-grid subgrid-gap col-screen"><p>This results in a distribution that is much more normal, so should make more sense when the colour map is applied to it. However, we can see from the QQ plot that the distribution deviates from normality at each extreme.</p><p>The following function was added to the Shiny app and applied to the lookup dictionary returned by the createChoroData function.</p></div><div id="YnJkUb6GhH" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">def quantileTransformer(dictionary):
    qt = QuantileTransformer(output_distribution=&#x27;normal&#x27;, random_state=0)
    values = qt.fit_transform(np.array(list(dictionary.values())).reshape(-1, 1)).flatten()
    return dict(zip(dictionary.keys(), values))</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="FTTwD2sFE_OvPCKTvntHZ" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="rNsoywOkAc" class="relative group/block article-grid subgrid-gap col-screen"><p>This change to the app produces the map below:</p><img id="Vw3h3wkaiE" style="margin:0 auto" src="/build/MapQuantileTransform-9626b9a5734bee0a16bef9cf83fbae45.PNG" alt="MapQuantileTransformed" data-canonical-url="../images/MapQuantileTransformed.PNG"/><p>This is definitely an improvement, as we can now see some colour variation across the map, however the range of colours is still quite narrow. This is due to the long tails shown in the density plot.</p><p>Another approach to this problem was to bin the data into deciles, adding the following step to the createChoroData function before returning a dictionary with the decile as the value in each key:value pair:</p></div><div id="ucS1IdUefj" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">df[&#x27;decile&#x27;] = pd.qcut(df[summary_statistic], 10, labels=False) # summary_statistic is either input.statistic() or &#x27;diff&#x27;</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="f0svkt_XE_PvE5UBdFxfj" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="wQp6Td9S5j" class="relative group/block article-grid subgrid-gap col-screen"><p>Using the deciles of the summary statistic gives a much better colour variation across the map, clearly highlighting the regional differences. This method has the added benefit of being conceptually simple, with the top 10% of values being assigned to the brightest colour and bottom 10% being assigned to the darkest colour.</p><img id="hMjcfSGDqZ" style="margin:0 auto" src="/build/MapDeciles-7e9cc765f287fbd74224d5e0224cdbf4.PNG" alt="MapDeciles" data-canonical-url="../images/MapDeciles.PNG"/><h2 id="geojson-compression" class="relative group"><span class="heading-text">GeoJSON compression</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#geojson-compression" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>The app is now working and displaying a useful colour map, however it is extremely slow to respond to any user input. This is because of the large size of the GeoJSON file, which has to be processed every time a change is made to the inputs. An easy work-around to this problem was to use <a target="_blank" href="https://mapshaper.org/" rel="noreferrer">mapshaper</a> to simplify the GeoJSON file, reducing its size using the Visvalingam / weighted area method with a 1% zoom level. The import was then changed to read from this GeoJSON file instead:</p></div><div id="IpqDcwlhkX" class="relative group/block article-grid subgrid-gap col-screen"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre style="display:block;overflow-x:auto;padding:0.8rem;background:transparent;color:black"><code class="language-python" style="white-space:pre">with open(appDir / &#x27;OutcodeCoordinates_compressed.json&#x27;, &#x27;r&#x27;) as f:
    outcodeCoordinates = json.load(f)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="8pjUzNua8-khQT-N_Otgp" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="esBnhSGdnC" class="relative group/block article-grid subgrid-gap col-screen"><h2 id="analysis" class="relative group"><span class="heading-text">Analysis</span><a class="no-underline text-inherit hover:text-inherit px-2 font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#analysis" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p><strong>Regional distribution of median house price</strong></p><p>With all time periods combined, the lowest medians are found in South Wales, Birmingham, horizontal strip near Manchester and Leeds, and Tyne and Wear. There is a large area of yellow centred around London, which spreads all across the South. Interestingly, if just filtering for one of the time periods, then we see that the yellow area around London is smaller and that in general areas outside London are darker. This indicates that if we look at a smaller time period of 10 years then there is a greater disparity between London and the rest of the country than if we look at the whole 30 year period, showing that house prices are increasing most rapidly in London and its immediate surroundings.</p><p><strong>Which areas have had the greatest change in median over time?</strong></p><p>Comparing the change in median across the map between the oldest and most recent time period, London and its surrounding area has clearly had the largest increase in average house price. What is intriguing is the fact that the map in general is much brighter when looking at the overall median, compared to looking at the change in median. This trend is telling us that over a 30 year period most areas have a similar median, however London and its surrounding area has had the greatest change in median over that period. This seems to be contradictory, but makes sense if we assume that the most rapid increase in London house prices has been in the last decade - in that case it is probable that at least 50% of the houses sold were sold before that period, making the median unaffected by the recent change.</p><p><strong>Have the house prices in any regions become more skewed over time?</strong></p><p>We can see that from 1995 - 2004, areas in the South generally had a more skewed distribution than areas in the North and Wales. However, from 2015+, the split is much less clear, with many of the areas with the most skewed distributions being located in the Midlands and the North. Strangely, these are also the areas that have some of the lowest median house prices. The patches of yellow in the 2015+ view are particularly concentrated around Leicester, Manchester and Sheffield. This change in trend over time suggests that in these areas in the North the gap between the average and most expensive houses has widened, whereas in the South that gap has narrowed. This could either be due to the average in the South shifting upwards, or due to the upper percentile in the other areas shifting upwards. Comparing the change in skew over time indicates that it is probably the latter that is having more of an effect. This could be explained by recent initiatives to reduce the North-South divide, with financial services and tech businesses establishing offices in Leeds and Manchester, which attracts individuals with higher salaries who can afford more expensive homes.</p><p><strong>How has the spread of house prices changed over time?</strong></p><p>The IQR shows the same regional distribution within each time period, with darker areas in Wales, the North and the Midlands (very similar to the regional distribution of the median); however the difference in colour is less pronounced from 2015+. Despite this, it is still London and its surrounding area that has had the greatest change in IQR over time. This illustrates how in London not only the average price is increasing, the spread of prices is increasing, even if outliers are ignored.</p><p><strong>Conclusion</strong></p><p>It is no surprise that the average house price is higher in the South of England compared the North, however this visualisation demonstrates that the North-South divide might not be so simple, at least when viewed through the lens of house prices. The housing market is complex, with prices being affected by many different factors, but in general, areas with better employment opportunities, amenities and transportation will have higher house prices because they are more desirable places to live. The median house price distribution by region shows that the socio-economic divide is not as clear as North vs South. The lowest values are concentrated around Wales, the strip West to East near Manchester and Leeds, and Tyne and Wear. However, some areas in the North have higher values, such as south Manchester, North Yorkshire and parts of Cumbria. Looking at the distribution of skew by region shows an even less clear divide between North and South, with the skew from 2015+ being particulary high in many areas in the North and the Midlands. The skew of the house price distribution could be seen as a measure of inequality or wealth disparity, showing that perhaps the wealth gap is now higher in certain areas of the North.</p><p>Looking at the trends in average (median) house price, we have found that the average has increased across England and Wales but much more rapidly in London and its surrounding area. It is particularly in the last decade that the average house price in London has seen a large spike. Furthermore, the majority of London house prices are now falling within a range that has increased massively compared to the rest of the country.</p></div><div></div><div class="flex pt-10 mb-10 space-x-4"><a class="flex-1 block p-4 font-normal text-gray-600 no-underline border border-gray-200 rounded shadow-sm group hover:border-blue-600 dark:hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-400 dark:text-gray-100 dark:border-gray-500 hover:shadow-lg dark:shadow-neutral-700" href="/"><div class="flex h-full align-middle"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" width="1.5rem" height="1.5rem" class="self-center transition-transform group-hover:-translate-x-1 shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path></svg><div class="flex-grow text-right"><div class="text-xs text-gray-500 dark:text-gray-400">About Me</div>About Me</div></div></a></div></main></article><script>((o,u)=>{if(!window.history.state||!window.history.state.key){let f=Math.random().toString(32).slice(2);window.history.replaceState({key:f},"")}try{let d=JSON.parse(sessionStorage.getItem(o)||"{}")[u||window.history.state.key];typeof d=="number"&&window.scrollTo(0,d)}catch(f){console.error(f),sessionStorage.removeItem(o)}})("positions", null)</script><link rel="modulepreload" href="/build/entry.client-K6EYMIDZ.js"/><link rel="modulepreload" href="/build/_shared/chunk-FBLNPC3V.js"/><link rel="modulepreload" href="/build/_shared/chunk-XJN3BT5Q.js"/><link rel="modulepreload" href="/build/_shared/chunk-2NH4LW52.js"/><link rel="modulepreload" href="/build/_shared/chunk-RE6LVKIZ.js"/><link rel="modulepreload" href="/build/_shared/chunk-YAIQ7LUU.js"/><link rel="modulepreload" href="/build/_shared/chunk-HTHE5KDW.js"/><link rel="modulepreload" href="/build/_shared/chunk-AAPZCWUN.js"/><link rel="modulepreload" href="/build/_shared/chunk-QB27XQSF.js"/><link rel="modulepreload" href="/build/_shared/chunk-JOLZ6LZB.js"/><link rel="modulepreload" href="/build/_shared/chunk-MITWS4PZ.js"/><link rel="modulepreload" href="/build/_shared/chunk-J6FHCSRC.js"/><link rel="modulepreload" href="/build/_shared/chunk-EEG6LHX7.js"/><link rel="modulepreload" href="/build/_shared/chunk-TEYZXLTV.js"/><link rel="modulepreload" href="/build/_shared/chunk-GUCIBHGO.js"/><link rel="modulepreload" href="/build/root-ZSMPVWLZ.js"/><link rel="modulepreload" href="/build/_shared/chunk-OCW4QGPJ.js"/><link rel="modulepreload" href="/build/routes/$-OW6NTZY2.js"/><script>window.__remixContext = {"url":"/housepricesvisualisation","state":{"loaderData":{"root":{"theme":"light","config":{"options":{"logo_text":"Dan Rooney"},"myst":"1.3.5","nav":[],"actions":[{"title":"Email","url":"mailto:danjrooney@hotmail.com","internal":false,"static":false},{"title":"LinkedIn","url":"https://uk.linkedin.com/in/danjrooney98","internal":false,"static":false}],"projects":[{"github":"https://github.com/dannycmd","id":"0f6d5d1e-e416-46a3-80ea-a6dccab1ef6b","thebe":{"binder":{"url":"https://mybinder.org/","provider":"github","repo":"https://github.com/dannycmd","ref":"HEAD"}},"thumbnail":"/build/cover-dde47569623d997a6d33d7dab01947db.jpg","exports":[],"bibliography":[],"title":"About Me","index":"aboutme","pages":[{"title":"Projects","level":1},{"slug":"housepricesvisualisation","title":"House Prices","description":"","date":"","thumbnail":"/build/EDADensityPlot-762c22be9aee1c62ccbfd91e164b194f.PNG","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}]},"CONTENT_CDN_PORT":"3100","MODE":"static"},"routes/$":{"config":{"options":{"logo_text":"Dan Rooney"},"myst":"1.3.5","nav":[],"actions":[{"title":"Email","url":"mailto:danjrooney@hotmail.com","internal":false,"static":false},{"title":"LinkedIn","url":"https://uk.linkedin.com/in/danjrooney98","internal":false,"static":false}],"projects":[{"github":"https://github.com/dannycmd","id":"0f6d5d1e-e416-46a3-80ea-a6dccab1ef6b","thebe":{"binder":{"url":"https://mybinder.org/","provider":"github","repo":"https://github.com/dannycmd","ref":"HEAD"}},"thumbnail":"/build/cover-dde47569623d997a6d33d7dab01947db.jpg","exports":[],"bibliography":[],"title":"About Me","index":"aboutme","pages":[{"title":"Projects","level":1},{"slug":"housepricesvisualisation","title":"House Prices","description":"","date":"","thumbnail":"/build/EDADensityPlot-762c22be9aee1c62ccbfd91e164b194f.PNG","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}]},"page":{"kind":"Notebook","sha256":"87b025f8bda686eebd03322ff9689fb695d6f9b113269bfa92505043b9b359c9","slug":"housepricesvisualisation","location":"/projects/HousePricesVisualisation.ipynb","dependencies":[],"frontmatter":{"title":"House Prices","content_includes_title":false,"kernelspec":{"name":"python3","language":"python","display_name":"Python 3 (ipykernel)"},"github":"https://github.com/dannycmd","thumbnail":"/build/EDADensityPlot-762c22be9aee1c62ccbfd91e164b194f.PNG","exports":[{"format":"ipynb","filename":"HousePricesVisualisation.ipynb","url":"/build/HousePricesVisualisa-d120ccf5a5914199bfe2f98b07aa2ab9.ipynb"}]},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This project involved building an interactive web app, using Shiny for Python, to display house prices in England and Wales, adding a Choropleth layer to visualise the differences by region. The aim was to demonstrate the Shiny software and investigate trends in house prices over time and across different regions of England and Wales. This notebook contains is analysis into the data and a walkthrough of how the app was built, but if you’d just like to view the app then use this link:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"C9FWimLaPm"}],"key":"DP3PxPxqsk"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"emphasis","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"link","url":"https://drooney.shinyapps.io/housepricesvisualisation/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"House Prices Visualisation","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"L50nyh4dL6"}],"urlSource":"https://drooney.shinyapps.io/housepricesvisualisation/","key":"mvRw8HR4Oi"}],"key":"GBZcpCF6PX"}],"key":"H6fLDyqiRH"},{"type":"heading","depth":2,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"About the data","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"LovOAuKNUZ"}],"identifier":"about-the-data","label":"About the data","html_id":"about-the-data","implicit":true,"key":"uR9h6fxIoY"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"For this project I used the Price Paid Data published monthly by the UK government, which tracks property sales in England and Wales submitted to HM Land Registry for registration. The dataset contains single residential properties sold for value since 1995, and since 2013 includes transfers under power of sale/repossessions, buy-to-lets (where identifiable by Mortgage type) and transfers to non-private individuals. This data is also used by property websites such as Zoopla and Rightmove to allow users to track property prices.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"VUgxgdnUK1"}],"key":"F49utXgGlf"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"The Price Paid Data includes information on all residential property sales in England and Wales that are sold for value and are lodged with us for registration. It excludes:","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"jkvhpz0GF4"}],"key":"xJ0zGZ7X2T"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":13,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"sales that have not been lodged with HM Land Registry","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"vRZX3FvVjg"}],"key":"YbHTa9xWHS"},{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"sales that were not for value","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"KxrYjNgzPW"}],"key":"MD137U1wyg"},{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"transfers, conveyances, assignments or leases at a premium with nominal rent, which are:","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"m0ovEITY5k"}],"key":"Q45lF5uqeB"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"‘Right to buy’ sales at a discount","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"AuVfwIrIdG"}],"key":"Vo2j3g5syV"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"subject to an existing mortgage","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"Irzb2dVCrK"}],"key":"qZoJsStJRJ"},{"type":"listItem","spread":true,"position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"to effect the sale of a share in a property, for example, a transfer between parties on divorce","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"si8p2jECZF"}],"key":"FPHEansthh"},{"type":"listItem","spread":true,"position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"by way of a gift","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"vPSHC0icOJ"}],"key":"MkVVIb6jkm"},{"type":"listItem","spread":true,"position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"under a compulsory purchase order","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"DewevjEsyr"}],"key":"Mdk3IU2OEL"},{"type":"listItem","spread":true,"position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"under a court order","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"YkFXVCIw5A"}],"key":"fSXLcbovHO"},{"type":"listItem","spread":true,"position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"to Trustees appointed under Deed of appointment","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"P3mmKYYtZJ"}],"key":"IgY4KrqkXa"},{"type":"listItem","spread":true,"position":{"start":{"line":23,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"text","value":"Vesting Deeds Transmissions or Assents of more than one property","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"j6oBlYIy5K"}],"key":"nCgy3CF71O"}],"key":"DddYsiZ8T6"},{"type":"heading","depth":2,"position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"Initial planning","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"rx1suvBSvJ"}],"identifier":"initial-planning","label":"Initial planning","html_id":"initial-planning","implicit":true,"key":"AeoO6IhWw3"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":27,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":27,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"text","value":"What granularity to use? e.g. county, town, postcode","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"BjJ8aUrF1F"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":28,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"text","value":"The dataset contains the postcode of each property, and every postcode has a clearly defined area, which should be available online","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"EHfDHjMbC0"}],"key":"Eaxr2Nza0f"},{"type":"listItem","spread":true,"position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"text","value":"The whole postcode is likely too granular - using the area code or district code should be a good compromise","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"QlwOE0BQ8U"}],"key":"GSuGs6BpRx"}],"key":"wBOoEbWH9G"}],"key":"Vb5jiIzIHX"},{"type":"listItem","spread":true,"position":{"start":{"line":30,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"text","value":"How to aggregate price paid by area?","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"Xun5lTH5LN"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":31,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"children":[{"type":"text","value":"Allow user to choose which statistic to show on the map","position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"key":"ojtCbdhYZw"}],"key":"Nrm2GHEpqa"},{"type":"listItem","spread":true,"position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"text","value":"Could also compare these summary statistics between points in time, which would highlight the areas which have seen the greatest changes in price over time","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"VTw8Qb9KAF"}],"key":"ERYXb23bDw"},{"type":"listItem","spread":true,"position":{"start":{"line":33,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"text","value":"Will need to look at the distributions of house price to determine the summary statistics that will be suitable","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"key":"Y1ZaYmLrKc"}],"key":"rrcrBqPoOO"}],"key":"nOZqKBd8Nb"}],"key":"GvdN5nDip8"}],"key":"WALnWDDRwU"},{"type":"heading","depth":2,"position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"text","value":"Preparing the data","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"bv8NGWplmU"}],"identifier":"preparing-the-data","label":"Preparing the data","html_id":"preparing-the-data","implicit":true,"key":"Mqh8Jh5fLz"},{"type":"paragraph","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"text","value":"Loading the CSV file into a MySQL database:","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"KqqphQzZ3Z"}],"key":"uL1Dud72Ls"},{"type":"code","lang":"sql","value":"DROP DATABASE IF EXISTS `houseprices`;\nCREATE DATABASE `houseprices`;\nUSE `houseprices`;\n\nCREATE TABLE `pricePaid` (\n`unique_id` VARCHAR(100),\n`price_paid` DECIMAL,\n`deed_date` DATE,\n`postcode` VARCHAR(8),\n`property_type` VARCHAR(1),\n`new_build` VARCHAR(1),\n`estate_type` VARCHAR(1),\n`saon` VARCHAR(50),\n`paon` VARCHAR(50),\n`street` VARCHAR(50),\n`locality` VARCHAR(50),\n`town` VARCHAR(50),\n`district` VARCHAR(50),\n`county` VARCHAR(50),\n`transaction_category` VARCHAR(1),\n`linked_data_uri` VARCHAR(1),\nPRIMARY KEY (unique_id)\n);\n\nSET GLOBAL local_infile=ON;\nSET autocommit=0;\nSET unique_checks=1;\nSET foreign_key_checks=0;\n\nLOAD DATA LOW_PRIORITY \nLOCAL INFILE 'Path/To/Project/pricepaid.csv'\nINTO TABLE pricePaid \nCHARACTER SET armscii8\nFIELDS TERMINATED BY ','\nENCLOSED BY '\"'\nLINES TERMINATED BY '\\n' \n(`unique_id`,`price_paid`,`deed_date`,`postcode`,`property_type`,`new_build`,`estate_type`,`saon`,`paon`,`street`,`locality`,`town`,`district`,`county`,`transaction_category`,`linked_data_uri`);","position":{"start":{"line":39,"column":1},"end":{"line":77,"column":1}},"key":"Y8ayZgm8M3"}],"key":"VhiLXjs49I"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"I had originally planned to use the full dataset in my Shiny app, however the full table is ~5GB in size with ~29m rows. For EDA purposes I am taking a sample of the data so that I can easily load the data into memory in Python. Taking a simple random sample of the data would mean that the number of samples from each area would be proportional to the population of that area, so to ensure that each area had an equal number of samples I would use stratified sampling instead.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iPm3UXF2Ew"}],"key":"mxhJexfdYM"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"I needed to choose a level of granularity to which to stratify the data. A UK postcode is made up of 2 parts, the outward code (first part) and inward code (second part), separated by a space. The outward code consists of the postcode area (either 1 or 2 letters) followed by the postcode district (usually 1 or 2 digits). For example, in the postcode PO16 7GZ, PO16 is the outward code (or outcode), PO is the area and 16 is the district.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FqY3hFQmbB"}],"key":"DRvYaoT8ON"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"OutCode was added as a generated column to the pricePaid table, along with a Year column and a YearBin column.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"TxwJSnbg0n"}],"key":"t624L8dqLZ"},{"type":"code","lang":"sql","value":"ALTER TABLE pricePaid ADD COLUMN OutCode VARCHAR(4) GENERATED ALWAYS AS substr(postcode, 1, locate(' ', postcode) - 1) STORED;\nALTER TABLE pricePaid ADD COLUMN Year INT GENERATED ALWAYS AS year(cast(deed_date as date)) STORED;\nALTER TABLE pricePaid ADD COLUMN YearBin VARCHAR(4) GENERATED ALWAYS AS case when (Year \u003c 2005) then '1995 - 2004' when (Year \u003c 2015) then '2005 - 2014' else '2015 +' end STORED;","position":{"start":{"line":7,"column":1},"end":{"line":11,"column":1}},"key":"J57RYtSj8P"}],"key":"fqo7kSOpfU"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Creating an index on Outcode and YearBin to speed up the stratified sample query.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LujSY6AnPY"}],"key":"hFULAa3Mnq"},{"type":"code","lang":"sql","value":"CREATE INDEX OutcodeYearBinIndex ON pricepaid (Outcode, YearBin);","position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"key":"D5DGJTveOa"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Taking a stratified sample of 100 observations for each distinct OutCode and YearBin. This is to be used for EDA.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"rR5FXQjHD8"}],"key":"wlLaZIZDeJ"},{"type":"code","lang":"sql","value":"SELECT t.* FROM\n(SELECT pp.*, ROW_NUMBER() OVER (PARTITION BY OutCode, YearBin ORDER BY RAND()) AS SeqNum\nFROM pricePaid pp) t\nWHERE t.SeqNum \u003c= 100\nINTO LOCAL OUTFILE '/Path/To/Project/pricepaidsample.csv'\nFIELDS TERMINATED BY ','\nENCLOSED BY '\"'\nLINES TERMINATED BY '\\n';","position":{"start":{"line":9,"column":1},"end":{"line":18,"column":1}},"key":"t3xRvVcCce"}],"key":"MlEgmqrS2t"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Exploratory data analysis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FMc0AnEDYc"}],"identifier":"exploratory-data-analysis","label":"Exploratory data analysis","html_id":"exploratory-data-analysis","implicit":true,"key":"lWIm1eSWdw"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Importing the sample into Python and creating a density plot of all house prices:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MDuMhHNdvy"}],"key":"TPx5vGSsX9"}],"key":"xf5ff78Okl"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"from pathlib import Path\nimport os\nimport pandas as pd\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nimport numpy as np\n\n### Load data\nappDir = Path(os.path.abspath(''))\ndataset = pd.read_csv(appDir / \"pricepaidsample.csv\", delimiter='\\t', header=0, encoding=\"utf-8\")\n# remove missing postcodes and price paid values of zero\ndataset = dataset[~((dataset['postcode'].isnull()) | (dataset['price_paid'] == 0))]\ndataset['price_paid_mil'] = dataset['price_paid'] / 1000000\n\n# density plot of price paid\nfig, ax = plt.subplots()\nsns.kdeplot(df['price_paid_mil'])\nax.set_xlabel('Price Paid (£m)')\nax.set_xlim(left=-5)\nax.set_ylim(bottom=-0.00005)\nax.set_title('Density Plot of Price Paid Sample (£m)')\nax.tick_params(bottom=True, left=True)\nplt.show()","key":"C78YJq6Did"},{"type":"output","id":"uzO67DcAWn1LCX7hAiNoJ","data":[],"key":"JuvuGfnwXy"}],"key":"KNdR6ESvyA"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"image","url":"/build/EDADensityPlot-762c22be9aee1c62ccbfd91e164b194f.PNG","alt":"EDADensityPlot","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"v8FVrwomhl","urlSource":"../images/EDADensityPlot.PNG"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This distribution is heavily right skewed due to some houses selling for 100s of millions. Looking at the summary statistics for the dataset indicates that the vast majority of price_paid values are less than £1m, so filtering out values greater than this should give a better view of the distribution.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"X0mG74nBts"}],"key":"qKhbl1vStJ"}],"key":"kzu1gQYr6N"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"dataset.describe()","key":"w4eFpp3LPP"},{"type":"output","id":"RjaJ2RXcFktmfHzlVl3fY","data":[],"key":"GC2m9736dR"}],"key":"TqGhmwtdtT"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"image","url":"/build/summarystats-e5b0c758566309021415e53a562126ef.PNG","alt":"summarystats","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"P5GhMjyovK","urlSource":"../images/summarystats.PNG"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Applying this \u003c= £1m filter and also splitting the data by region to produce a ridge plot so that we compare the distributions by region:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gaU1bhzxJB"}],"key":"L0IJgDChT2"}],"key":"kOCc02TyLN"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"### postcode area to region lookup\noutcodeRegion = pd.read_csv(appDir / \"postcode_region_lookup.csv\")\noutcodeRegion['Area'] = outcodeRegion['Postcode prefix']\ndataset['Area'] = dataset['Outcode'].replace('\\d+', '', regex=True)\ndf = pd.merge(dataset, outcodeRegion, on=\"Area\", how=\"left\")\n\n# filtering data for house prices \u003c= £1m\ndf_filtered = df[df['price_paid_mil'] \u003c= 1]\n\n# ridge plot of log price paid by region\ndef ridgePlot(df, xVar, groups):\n    sns.set_theme(style=\"white\", rc={\"axes.facecolor\": (0, 0, 0, 0)})\n    palette = sns.color_palette(\"Set2\", 12)\n    g = sns.FacetGrid(df, palette=palette, row=groups, hue=groups, aspect=9, height=1.2)\n    g.map_dataframe(sns.kdeplot, x=xVar, fill=True, alpha=1)\n    g.map_dataframe(sns.kdeplot, x=xVar, color='black')\n\n    def label(x, color, label):\n        ax = plt.gca()\n        ax.text(0, .2, label, color='black', fontsize=13,\n                ha=\"left\", va=\"center\", transform=ax.transAxes)\n\n    g.map(label, groups)\n    g.figure.subplots_adjust(hspace=-.5)\n    g.set_titles(\"\")\n    g.set(yticks=[], xlabel=\"Price Paid £m\", ylabel=\"\")\n    g.despine(left=True)\n\nridgePlot(df_filtered, \"price_paid_mil\", \"UK region\")","key":"wTMvAUbZsl"},{"type":"output","id":"j1gDA8eNsmiWNdNm2swCC","data":[],"key":"zMQXAXQtgi"}],"key":"EBveHaUdae"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"image","url":"/build/EDARidgePlot-3b1de7079af22de03c167b3104d4bdd5.PNG","alt":"EDARidgePlot","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uWrSvMHPM0","urlSource":"../images/EDARidgePlot.PNG"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This shows that all regions have the same type of distribution - though some regions, such as London and South East, are more heavily right skewed. Next I am trying to see if I can fit this distribution to a known distribution, specifically the lognormal distribution (a distribution is lognormal if its log follow a normal distribution):","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Rtr0hoHVOR"}],"key":"I6uA9p2RXk"}],"key":"L8OwYcnMNr"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"import scipy\nimport numpy as np\n\n### determining the distribution type\nshape, location, scale = scipy.stats.lognorm.fit(df_filtered['price_paid_mil'])\nmu, sigma = np.log(scale), shape\nxmin, xmax = np.min(df_filtered['price_paid_mil']), np.max(df_filtered['price_paid_mil'])\nx = np.linspace(xmin, xmax, 1000)\n\nfig, ax = plt.subplots()\nplt.plot(x, scipy.stats.lognorm.pdf(x, shape, location, scale), label=\"Lognormal\")\nsns.kdeplot(df_filtered, x=\"price_paid_mil\", label=\"Density Plot\")\nax.set_xlabel('Price Paid (£m)')\nax.set_ylim(bottom=-0.1)\nax.set_title('Price Paid Sample (£m) - Density Plot vs Fitted Lognormal Distribution')\nax.tick_params(bottom=True, left=True)\nplt.legend(facecolor='white')\nplt.show()","key":"Nz8LgOpmRU"},{"type":"output","id":"x9WrM2kxdUQVPOBeV_usQ","data":[],"key":"KujSRJVQnk"}],"key":"RoaVjNRYPO"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"image","url":"/build/EDAFitToLognormal-c7c81da0dbd92113709c5de0d5d269c8.PNG","alt":"EDAFitToLognormal","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dDsu4ffJHt","urlSource":"../images/EDAFitToLognormal.PNG"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Except for some of the data points at the peak of the curve, this appears to give a very close fit. We could conclude from this that the overall distribution of house prices less than £1m closely fits a lognormal distribution. We can check this with a QQ plot of the log of house price against a reference normal distribution:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"m3CKPcFU9Q"}],"key":"FWoNYBsjrR"}],"key":"QgwfKdJL0c"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"import statsmodels.api as sm\n\ndf_filtered['log_price_paid_mil'] = np.log(df_filtered['price_paid_mil'])\n\n### QQ plot\nfig, ax = plt.subplots(2, 1)\nsm.qqplot(data=df_filtered['log_price_paid_mil'], line='s', ax=ax[0])\nsns.kdeplot(df_filtered['log_price_paid_mil'], ax=ax[1])\nplt.show()","key":"vlttXil9Bh"},{"type":"output","id":"mtVYtjiDZ0y1av_tUpyAh","data":[],"key":"wX8XRJ3a57"}],"key":"PcAyxV7U6p"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"image","url":"/build/EDAQQPlot-c692caa2546662c6c49fd8555e487010.PNG","alt":"EDAQQPlot","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HCeJDz9LTh","urlSource":"../images/EDAQQPlot.PNG"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The log of price paid closely matches the normal distribution in the centre, but deviates significantly in the tails, suggesting that the data does not actually quite follow a lognormal distribution. Therefore, instead of using the lognormal parameters as summary statistics in my visualisation to describe the data, non-parametric statistics such as the median and interquartile range (IQR) will be more appropriate.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"E2K6BVEalS"}],"key":"xrbddWWybu"}],"key":"E5HbDqW7eY"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Transforming and aggregating the data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"U7ZTY1GCl9"}],"identifier":"transforming-and-aggregating-the-data","label":"Transforming and aggregating the data","html_id":"transforming-and-aggregating-the-data","implicit":true,"key":"WezLFbYa8n"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Before the data can be used in the Shiny app, it needs to be aggregated. Doing this aggregation outside the Shiny app and reading the aggregated data directly instead greatly improves the performance of the app, hence why I’m using SQL below.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"A9qmaBSZGK"}],"key":"zpez7A7t4A"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"I’m choosing to use Outcode as the area to aggregate by, since these areas on the map should granular enough to give a detailed spatial distribution on the map, and each outcode should be of a similar size. The summary statistics are chosen taking into consideration the highly right skewed shape of the pseudo-lognormal distribution - the median will be a better estimate of the average value than the arithmetic mean (because it’s not affected by outliers), and the IQR will be a better estimate of spread for the same reason. I am also including skew since we know that the distributions of some regions are more heavily skewed than others.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"c4EaZmDlJg"}],"key":"CRmZSKZ803"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"We are also aggregating by YearBin so that we will be able to compare the data between different time periods.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ruvcLcDvfF"}],"key":"afeOVQ8qKA"},{"type":"code","lang":"sql","value":"CREATE TABLE minMaxMeanCountStddev AS\nSELECT Outcode, YearBin\n,MIN(price_paid) AS min\n,MAX(price_paid) AS max\n,AVG(price_paid) AS mean\n,STD(price_paid) AS stddev\n,COUNT(*) AS count\nFROM pricePaid\nGROUP BY Outcode, YearBin;\n\nCREATE TABLE skew AS\nSELECT t1.Outcode, t1.YearBin\n,SUM(POWER((price_paid - t1.mean), 3) / ((t1.count - 1) * POWER(t1.stddev, 3))) as skew\nFROM minMaxMeanCountStddev t1\nINNER JOIN pricePaid pp on t1.Outcode = pp.Outcode and t1.YearBin = pp.YearBin\nWHERE t1.count \u003c\u003e 1 and t1.stddev \u003c\u003e 0 --avoiding division by zero error\nGROUP BY t1.Outcode, t1.YearBin;\n\n--this method of calculating the quartiles will not be entirely accurate if the actual quartile falls between 2 values, but it is close enough for this purpose\nCREATE TABLE quartiles AS\nSELECT Outcode, YearBin, QUARTILE, MAX(price_paid) AS Q1_Q2_Q3\nFROM \n(SELECT Outcode, YearBin, price_paid, NTILE(4) OVER (PARTITION BY Outcode, YearBin ORDER BY price_paid) AS QUARTILE\nFROM pricepaid) S\nWHERE QUARTILE \u003c= 3\nGROUP BY Outcode, YearBin, QUARTILE;\n\nCREATE TABLE quartilesTransposed as \nSELECT s.Outcode, s.YearBin\n,SUM(s.lowerQuartile) AS lowerQuartile\n,SUM(s.median) AS median\n,SUM(s.upperQuartile) AS upperQuartile\nFROM\n(SELECT Outcode, YearBin\n,CASE WHEN Quartile = 1 THEN Q1_Q2_Q3 ELSE 0 END AS lowerQuartile\n,CASE WHEN Quartile = 2 THEN Q1_Q2_Q3 ELSE 0 END AS median\n,CASE WHEN Quartile = 3 THEN Q1_Q2_Q3 ELSE 0 END AS upperQuartile\nFROM quartiles) s\nGROUP BY s.Outcode, s.YearBin;\n\nSELECT t1.*, t2.median, t2.lowerQuartile, t2.upperQuartile, t3.skew\n, t1.max - t1.min AS range_, t2.upperQuartile - t2.lowerQuartile AS IQR\nFROM minMaxMeanCountStddev t1\nINNER JOIN quartilesTransposed t2 on t1.Outcode = t2.Outcode and t1.YearBin = t2.YearBin\nINNER JOIN skew t3 on t1.Outcode = t3.Outcode and t1.YearBin = t3.YearBin\nINTO LOCAL OUTFILE '/Path/To/Project/summary.csv'\nFIELDS TERMINATED BY ','\nENCLOSED BY '\"'\nLINES TERMINATED BY '\\n';","position":{"start":{"line":9,"column":1},"end":{"line":59,"column":1}},"key":"ZWQf7NbDBy"}],"key":"r9lEBb0bVc"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now we can load the aggregated data into Python and additionally prepare a GeoJSON file, which is needed so that the Shiny app knows where the boundaries of each Outcode area are.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cHIgozJOdf"}],"key":"ep2za6V4Gc"}],"key":"c3Q8u29nHk"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"from pathlib import Path\nimport pandas as pd\n\n### Load aggregated data\nappDir = Path(__file__).parent\nsummary = pd.read_csv(appDir / 'app/summary.csv', encoding='utf-8', delimiter=',')\nsummary = summary[(~summary['Outcode'].isnull())]\nsummary = summary.rename(columns={\"range_\": \"range\"})","key":"Phncuqeyq6"},{"type":"output","id":"Xl7BDUZ2SXGchzSnw84ZJ","data":[],"key":"ovybaRqylJ"}],"key":"wuReO1pynu"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"A folder containing a GeoJSON file with the polygon coordinates of each Outcode was downloaded online (","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zeKnObSeId"},{"type":"link","url":"https://github.com/mhl/postcodes-mapit","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"https://​github​.com​/mhl​/postcodes​-mapit","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pnNZkF9s9z"}],"urlSource":"https://github.com/mhl/postcodes-mapit","error":true,"key":"JCllSrENNk"},{"type":"text","value":"). This is combined into a single GeoJSON file:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vy6cOj9EB5"}],"key":"K06mBfBhCC"}],"key":"wIRQZPSfTY"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"import json\nimport itertools\n\n### Get polygon coordinates (GeoJSON) of each PostcodeArea\ngeojsonDir = appDir / 'districts'\n# combine all PostcodeArea datasets, one for each PostcodeArea\ngeojsonDict = {}\nfor file in geojsonDir.glob('*.geojson'):\n    with open(file, 'r') as f:\n        geojsonDict[str(file).split('\\\\')[-1][:-8]] = json.load(f)\n# add id string to link to summary data\nfor key in geojsonDict.keys():\n    geojsonDict[key]['features'][0]['id'] = key\n# changing format of geojsonDict to meet required format for Choropleth function\ngeojsonList = []\nuniqueOutcodes = summary['Outcode'].unique().tolist()\nfor outcode in geojsonDict.keys():\n    features = geojsonDict[outcode]['features']\n    if outcode in uniqueOutcodes:\n        geojsonList.append(features[0])\ngeojsonDict = {}\ngeojsonDict['type'] = 'FeatureCollection'\ngeojsonDict['features'] = geojsonList\n\n### make sure summary data has a row for every Outcode and YearBin - set aggregate values to null if missing\nuniqueYearBins = summary['YearBin'].unique().tolist()\ncrossJoin = list(itertools.product(uniqueOutcodes, uniqueYearBins))\ncrossJoin = pd.DataFrame(crossJoin, columns=[\"Outcode\", \"YearBin\"])\nsummary = pd.merge(crossJoin, summary, how=\"left\", on=[\"Outcode\", \"YearBin\"])","key":"D3KapqX6ph"},{"type":"output","id":"W7r7KXfzHc1EyOGjv7fit","data":[],"key":"Wcx4ocBc75"}],"key":"i61pr0ovzR"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"As the final step in the data preparation, the GeoJSON file and summary dataset were exported to the folder so that they can be read into the Shiny app:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MKgmA1XaZS"}],"key":"hGjFQcUWQO"}],"key":"Y0jneY5WdD"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# export as geojson dictionary as json file\nwith open(appDir / 'app/OutcodeCoordinates.json', 'w') as fp:\n    json.dump(geojsonDict, fp)\n\n# export summary dataframe as csv\nsummary.to_csv(appDir / 'app/summary.csv', index=False)","key":"MzI5k5ZC3g"},{"type":"output","id":"Whkz2DcYzN3ktYJmOLN2m","data":[],"key":"m1aFiiCJq7"}],"key":"LKz03N4TAf"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Building the Shiny app","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dDgsBc5ax0"}],"identifier":"building-the-shiny-app","label":"Building the Shiny app","html_id":"building-the-shiny-app","implicit":true,"key":"lVih67aksz"}],"key":"PD0VXMn6V0"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The app.py program of the Shiny app consists of 3 main parts:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zdjiKvN5Ir"}],"key":"XDX6nWVZ5X"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"importing the data","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MgI9uN2S0I"}],"key":"FNrQNgYDuT"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"building the HTML interface","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"E4faDiQrym"}],"key":"UwhqYsLYRh"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"defining a server function","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"CCDdKHU7gZ"}],"key":"HMCanHvh2F"}],"key":"nbBdgJXmOS"}],"key":"pu4gBLq6aH"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Importing the data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lqi2klCIBu"}],"identifier":"importing-the-data","label":"Importing the data","html_id":"importing-the-data","implicit":true,"key":"heAkoljmXn"}],"key":"m1jWK3PnCH"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"from pathlib import Path\nimport os\nimport json\nimport pandas as pd\nfrom ipyleaflet import Map, Choropleth\nfrom shiny import App, Inputs, Outputs, Session, ui, reactive, render\nfrom shinywidgets import output_widget, render_widget\nfrom branca.colormap import linear\n\n### Load data\nappDir = Path(os.path.abspath(''))\nwith open(appDir / 'OutcodeCoordinates.json', 'r') as f:\n    outcodeCoordinates = json.load(f)\noutcodes = [i['id'] for i in outcodeCoordinates['features']]\nsummary = pd.read_csv(appDir / 'summary.csv', encoding='utf-8', delimiter=',')\nsummary = summary[(~summary['Outcode'].isnull()) \u0026 (summary['Outcode'].isin(outcodes))]\nsummary = summary.rename(columns={\"range_\": \"range\"})\nyearBins = list(summary['YearBin'].unique())","key":"Ng6FU7Vl8V"},{"type":"output","id":"xJ96fL7tWL4oODj_JusYz","data":[],"key":"gXD3Ie6CWr"}],"key":"Bar68M9S8U"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Building the HTML interface","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uU6glcIVl9"}],"identifier":"building-the-html-interface","label":"Building the HTML interface","html_id":"building-the-html-interface","implicit":true,"key":"nRg2LBvdXg"}],"key":"aKaOkmsZoz"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Nest Python functions to build an HTML interface\napp_ui = ui.page_fillable( \n    # Layout the UI with Layout Functions\n    # Add Inputs with ui.input_*() functions \n    # Add Outputs with ui.output_*() functions\n    ui.layout_sidebar(\n        ui.sidebar(\n            ui.input_checkbox_group('yearBin', \"Time Period\", yearBins),\n            ui.input_select('statistic', \"House Price Summary Statistic\", ['mean', 'median', 'min', 'max', 'IQR', 'range', 'skew'], selected='median', multiple=False),\n            ui.input_switch(\"switch\", \"Compare Summary Statistic between Time Periods\", False)\n        ),\n        ui.card(\n            ui.output_image(\"image\", height='10px'),\n            output_widget(\"map\", fill=True),\n            full_screen=True,\n            fill=True\n        ),\n        ui.card_footer(\"Contains HM Land Registry data © Crown copyright and database right 2021. This data is licensed under the Open Government Licence v3.0.\"),\n        full_screen=True\n    ),\n    title=\"House Prices Visualisation\"\n)","key":"FjbDvp9VFq"},{"type":"output","id":"u7owK-h4gmZ9CBPdd_Nmo","data":[],"key":"UbZ6HJ0Zem"}],"key":"stXfbVEDiC"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This results in a HTML template that looks like this:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KklazjiNs8"}],"key":"TFUHoxi9zP"},{"type":"image","url":"/build/HTMLTemplate-8d0c4305e9a1ca30330c8d39456bdeec.PNG","alt":"HTMLTemplate","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jRyY0xYGE4","urlSource":"../images/HTMLTemplate.PNG"}],"key":"zy8dNXsNu0"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Defining a server function","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Hypyl8sjFE"}],"identifier":"defining-a-server-function","label":"Defining a server function","html_id":"defining-a-server-function","implicit":true,"key":"VDnvrUngw3"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Within the server function, the createChoroData function is reactive and will be called every time one of the inputs to the app changes. The functions uses the user inputs to filter the dataset and return a dictionary containing a key for each Outcode and a value corresponding to the summary statistic.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wyA0bGhAYn"}],"key":"gYPi4jI24Y"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The createChoroData function also contains logic for if more than one time period is selected - in this case the function will calculate the difference between the summary statistics of the earliest and latest time period selected.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"mpSkENytyB"}],"key":"ej08FbDSDV"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"The map function creates an ipyleaflet Map object and adds a Choropleth layer to it.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"KGWZcclQNR"}],"key":"fxEYJxQziG"}],"key":"YBWu24FFPZ"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Define server\ndef server(input: Inputs, output: Outputs, session: Session):\n    # add colour map image\n    @render.image\n    def image():\n        img = {\"src\": appDir / \"ColourMap.jpg\", \"width\": \"300px\"}  \n        return img\n\n    # function to filter the summary dataset and return a lookup dictionary with a key for each Outcode\n    @reactive.calc\n    def createChoroData():\n\n        # select all time periods if none are selected\n        if input.yearBin() == tuple():\n            filter = yearBins\n        else:\n            filter = list(input.yearBin())\n\n        # logic for comparing summary stastics between time periods\n        if input.switch():\n            minYearBin = filter[0]\n            maxYearBin = filter[-1]\n            dfMin = summary[summary['YearBin'] == minYearBin][['Outcode', input.statistic()]]\n            dfMax = summary[summary['YearBin'] == maxYearBin][['Outcode', input.statistic()]]\n            df = pd.merge(dfMin, dfMax, how=\"inner\", on=\"Outcode\")\n            df['diff'] = df[input.statistic() + '_y'] - df[input.statistic() + '_x']\n            df = df.set_index('Outcode')\n            df['decile'] = pd.qcut(df['diff'], 10, labels=False)\n            return df['decile'].to_dict()                \n        # if not comparing time periods then just show summary statistic\n        else:\n            df = summary[summary['YearBin'].isin(filter)].set_index('Outcode')\n            df['decile'] = pd.qcut(df[input.statistic()], 10, labels=False)\n            return df['decile'].to_dict()\n\n    ### For each output, define a function that generates the output\n    @render_widget  \n    def map():\n        # create a Map object and add a Choropleth layer to it\n        m = Map(center=(54.00366, -2.547855), zoom=5.5, zoom_snap=0.2, zoom_delta=0.2)\n\n        try:\n            layer = Choropleth(\n                    geo_data=outcodeCoordinates,\n                    choro_data=createChoroData(),\n                    key_on='id',\n                    colormap=linear.viridis,\n                    border_color='black',\n                    style={'fillOpacity': 0.8, 'dashArray': '5, 5'}\n                )\n        except:\n            raise IndexError(\"Must select more than one time period if comparing summary statistic between time periods.\")\n\n        m.add(layer)\n\n        return m\n\n# Call App() to combine app_ui and server() into an interactive app\napp = App(app_ui, server)","key":"SOmlHP0e7w"},{"type":"output","id":"o6CuYK6iHi-qrYRSQDYF3","data":[],"key":"bn3JV3pv9f"}],"key":"YO1ieVFjWV"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Transforming the data (again)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gZJaMaf8hN"}],"identifier":"transforming-the-data-again","label":"Transforming the data (again)","html_id":"transforming-the-data-again","implicit":true,"key":"ZcTtFw0km0"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The Shiny app is now working, however it is not very insightful because (except for a couple of areas in London) every area appears to be the same colour:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VXmyvF27Wp"}],"key":"kF5dzji8Q8"},{"type":"image","class":"bg-primary","url":"/build/MapNoTransformation-c1b1cddad762ed00490e0d614bd3ee85.PNG","alt":"MapNoTransformation","key":"Z73TdhIYzf","urlSource":"../images/MapNoTransformation.PNG"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"The density plot below, of all of the house prices in the sample, shows what the problem is. The data is highly right skewed, and because the colour map works by assigning a different colour to each quantile, the majority of data has the same colour.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"p2huK6Cx5l"}],"key":"usTKmLpRAL"}],"key":"BpWxFl4NGq"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"from pathlib import Path\nimport os\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport numpy as np\nimport statsmodels.api as sm\n\n### Load data\nappDir = Path(os.path.abspath('')).parent\nsummary = pd.read_csv(appDir / 'app/summary.csv', encoding='utf-8', delimiter=',')\nsummary = summary[(~summary['Outcode'].isnull())]\nsummary = summary.rename(columns={\"range_\": \"range\"})\n\nfig, ax = plt.subplots(2, 1, figsize=(10,12))\n\nsummary['median_mil'] = summary['median'] / 1000000\nsummary['log_median_mil'] = np.log(summary['median_mil'])\n\nfig, ax = plt.subplots(2, 1, figsize=(10, 12))\nsns.kdeplot(data=summary, x='median_mil', ax=ax[0])\nsm.qqplot(summary['median_mil'], ax=ax[1])\nax[0].set_xlabel('Price Paid Medians (£m)')\nax[0].set_xlim(left=-5)\nax[0].set_ylim(bottom=-0.005)\nax[0].set_title('Density Plot of Price Paid Sample Medians (£m)')\nax[0].tick_params(bottom=True, left=True)\nax[1].set_title('QQ Plot of Price Paid Sample Medians (£m)')\n\nplt.tight_layout()\nplt.show()","key":"TdNH2App8H"},{"type":"output","id":"kfNEHgEgFyOO1N_TyjGMD","data":[],"key":"D8Imxrkchx"}],"key":"Hwudyvu7bA"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"image","url":"/build/DensityPlot-d477947a2d64a092e2dae3758916715a.PNG","alt":"DensityPlot","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QB27pxEHPY","urlSource":"../images/DensityPlot.PNG"}],"key":"zztkLn9IZv"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"To resolve this, the QuantileTransformer function from scikit-learn was used to mathematically transform the data to follow a more normal distribution. This is a non-parametric method that works by mapping each quantile of the input distribution onto those of the output distribution (in this case the normal distribution) and applying the required transformation to each quantile so that they match as closely as possible. This is often used to transform features for machine learning problems because certain machine learning algorithms cannot effectively deal with non-normal features.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"H2SSALy7RB"}],"key":"G6uZwTgKjL"}],"key":"svKsXiOTVT"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"from sklearn.preprocessing import QuantileTransformer\n\nqt = QuantileTransformer(output_distribution='normal', random_state=0)\nvalues = qt.fit_transform(np.array(list(summary['median_mil'])).reshape(-1, 1)).flatten()\n\nfig, ax = plt.subplots(2, 1, figsize=(10, 12))\nsm.qqplot(data=np.array(values), ax=ax[1])\nsns.kdeplot(data=values, ax=ax[0])\nax[0].set_xlabel('Quantile Transformed Price Paid Medians (£m)')\nax[0].set_xlim(left=-5)\nax[0].set_ylim(bottom=-0.005)\nax[0].set_title('Density Plot of Quantile Transformed Price Paid Sample Medians (£m)')\nax[0].tick_params(bottom=True, left=True)\nax[1].set_title('QQ Plot of Quantile Transformed Price Paid Sample Medians (£m)')\n\nplt.tight_layout()\nplt.show()","key":"BvtkOTLwIZ"},{"type":"output","id":"C3h3eNqLtVqeVYpHxdEB1","data":[],"key":"RehMWYFpQf"}],"key":"OBtCwPXpxn"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"image","url":"/build/DensityPlotQuantileT-776e83704f57253f71d44c2bfdd6b32f.PNG","alt":"DensityPlotQuantileTransformed","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Oo6FNZNnlw","urlSource":"../images/DensityPlotQuantileTransformed.PNG"}],"key":"Ahw0hKlWRw"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This results in a distribution that is much more normal, so should make more sense when the colour map is applied to it. However, we can see from the QQ plot that the distribution deviates from normality at each extreme.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"t4oBwCDZca"}],"key":"J1nQSDY4Dw"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The following function was added to the Shiny app and applied to the lookup dictionary returned by the createChoroData function.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"remzDTqOQw"}],"key":"fflHUgsCe3"}],"key":"ODHiOk8bDa"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"def quantileTransformer(dictionary):\n    qt = QuantileTransformer(output_distribution='normal', random_state=0)\n    values = qt.fit_transform(np.array(list(dictionary.values())).reshape(-1, 1)).flatten()\n    return dict(zip(dictionary.keys(), values))","key":"jVbJr7fXPc"},{"type":"output","id":"FTTwD2sFE_OvPCKTvntHZ","data":[],"key":"o7MLdUe3fR"}],"key":"YnJkUb6GhH"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This change to the app produces the map below:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vJHfTZXXu8"}],"key":"e6VY3xHiwz"},{"type":"image","url":"/build/MapQuantileTransform-9626b9a5734bee0a16bef9cf83fbae45.PNG","alt":"MapQuantileTransformed","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Vw3h3wkaiE","urlSource":"../images/MapQuantileTransformed.PNG"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"This is definitely an improvement, as we can now see some colour variation across the map, however the range of colours is still quite narrow. This is due to the long tails shown in the density plot.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"kSZPq3XKpa"}],"key":"dbftSpFpLn"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Another approach to this problem was to bin the data into deciles, adding the following step to the createChoroData function before returning a dictionary with the decile as the value in each key:value pair:","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"HLyefNcRxl"}],"key":"ozYLo14o8w"}],"key":"rNsoywOkAc"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"df['decile'] = pd.qcut(df[summary_statistic], 10, labels=False) # summary_statistic is either input.statistic() or 'diff'","key":"WucJtzKZjz"},{"type":"output","id":"f0svkt_XE_PvE5UBdFxfj","data":[],"key":"XPTdneyT1i"}],"key":"ucS1IdUefj"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Using the deciles of the summary statistic gives a much better colour variation across the map, clearly highlighting the regional differences. This method has the added benefit of being conceptually simple, with the top 10% of values being assigned to the brightest colour and bottom 10% being assigned to the darkest colour.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Xf1aZGNJd5"}],"key":"txq4X5sevj"},{"type":"image","url":"/build/MapDeciles-7e9cc765f287fbd74224d5e0224cdbf4.PNG","alt":"MapDeciles","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hMjcfSGDqZ","urlSource":"../images/MapDeciles.PNG"},{"type":"heading","depth":2,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"GeoJSON compression","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"bowh8R8p9D"}],"identifier":"geojson-compression","label":"GeoJSON compression","html_id":"geojson-compression","implicit":true,"key":"Alvl8cajzg"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"The app is now working and displaying a useful colour map, however it is extremely slow to respond to any user input. This is because of the large size of the GeoJSON file, which has to be processed every time a change is made to the inputs. An easy work-around to this problem was to use ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"bw7TJMixhL"},{"type":"link","url":"https://mapshaper.org/","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"mapshaper","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"hkPYW39sxM"}],"urlSource":"https://mapshaper.org/","key":"u7XO5aSlHN"},{"type":"text","value":" to simplify the GeoJSON file, reducing its size using the Visvalingam / weighted area method with a 1% zoom level. The import was then changed to read from this GeoJSON file instead:","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Sb6M7emzrH"}],"key":"BpfnBXAxKz"}],"key":"wQp6Td9S5j"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"with open(appDir / 'OutcodeCoordinates_compressed.json', 'r') as f:\n    outcodeCoordinates = json.load(f)","key":"n9do3RBTps"},{"type":"output","id":"8pjUzNua8-khQT-N_Otgp","data":[],"key":"w05wXQcRqY"}],"key":"IpqDcwlhkX"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Analysis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CUnXZmJ3QF"}],"identifier":"analysis","label":"Analysis","html_id":"analysis","implicit":true,"key":"fUgMliMHkv"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Regional distribution of median house price","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MGv2rSaptB"}],"key":"xL38OnXGI0"}],"key":"XxSfsqaRwL"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"With all time periods combined, the lowest medians are found in South Wales, Birmingham, horizontal strip near Manchester and Leeds, and Tyne and Wear. There is a large area of yellow centred around London, which spreads all across the South. Interestingly, if just filtering for one of the time periods, then we see that the yellow area around London is smaller and that in general areas outside London are darker. This indicates that if we look at a smaller time period of 10 years then there is a greater disparity between London and the rest of the country than if we look at the whole 30 year period, showing that house prices are increasing most rapidly in London and its immediate surroundings.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"sA8CAlsY5a"}],"key":"CeER1C9Taw"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Which areas have had the greatest change in median over time?","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Vp6dgZlKZQ"}],"key":"d0Xyagib2w"}],"key":"jJe8wpAMAi"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Comparing the change in median across the map between the oldest and most recent time period, London and its surrounding area has clearly had the largest increase in average house price. What is intriguing is the fact that the map in general is much brighter when looking at the overall median, compared to looking at the change in median. This trend is telling us that over a 30 year period most areas have a similar median, however London and its surrounding area has had the greatest change in median over that period. This seems to be contradictory, but makes sense if we assume that the most rapid increase in London house prices has been in the last decade - in that case it is probable that at least 50% of the houses sold were sold before that period, making the median unaffected by the recent change.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"KxT4eyGQUJ"}],"key":"HHhef7ikhV"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"strong","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Have the house prices in any regions become more skewed over time?","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"UOWmEfi593"}],"key":"yORp1t3fRj"}],"key":"C5E4JIoi10"},{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"We can see that from 1995 - 2004, areas in the South generally had a more skewed distribution than areas in the North and Wales. However, from 2015+, the split is much less clear, with many of the areas with the most skewed distributions being located in the Midlands and the North. Strangely, these are also the areas that have some of the lowest median house prices. The patches of yellow in the 2015+ view are particularly concentrated around Leicester, Manchester and Sheffield. This change in trend over time suggests that in these areas in the North the gap between the average and most expensive houses has widened, whereas in the South that gap has narrowed. This could either be due to the average in the South shifting upwards, or due to the upper percentile in the other areas shifting upwards. Comparing the change in skew over time indicates that it is probably the latter that is having more of an effect. This could be explained by recent initiatives to reduce the North-South divide, with financial services and tech businesses establishing offices in Leeds and Manchester, which attracts individuals with higher salaries who can afford more expensive homes.","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"dB23bEfsRE"}],"key":"R3IcFBBSAs"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"strong","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"How has the spread of house prices changed over time?","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"OR5AAxis7b"}],"key":"OS0118lXOI"}],"key":"WmW6C8PQfv"},{"type":"paragraph","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"The IQR shows the same regional distribution within each time period, with darker areas in Wales, the North and the Midlands (very similar to the regional distribution of the median); however the difference in colour is less pronounced from 2015+. Despite this, it is still London and its surrounding area that has had the greatest change in IQR over time. This illustrates how in London not only the average price is increasing, the spread of prices is increasing, even if outliers are ignored.","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"W3UV4pqX3P"}],"key":"x4EZiqnhSE"},{"type":"paragraph","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"strong","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"Conclusion","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"sSFlvfPmDu"}],"key":"PTk3WKHGOA"}],"key":"KDVPuhsG1L"},{"type":"paragraph","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"It is no surprise that the average house price is higher in the South of England compared the North, however this visualisation demonstrates that the North-South divide might not be so simple, at least when viewed through the lens of house prices. The housing market is complex, with prices being affected by many different factors, but in general, areas with better employment opportunities, amenities and transportation will have higher house prices because they are more desirable places to live. The median house price distribution by region shows that the socio-economic divide is not as clear as North vs South. The lowest values are concentrated around Wales, the strip West to East near Manchester and Leeds, and Tyne and Wear. However, some areas in the North have higher values, such as south Manchester, North Yorkshire and parts of Cumbria. Looking at the distribution of skew by region shows an even less clear divide between North and South, with the skew from 2015+ being particulary high in many areas in the North and the Midlands. The skew of the house price distribution could be seen as a measure of inequality or wealth disparity, showing that perhaps the wealth gap is now higher in certain areas of the North.","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"HA6REaeMHS"}],"key":"RYvkikZHuC"},{"type":"paragraph","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"text","value":"Looking at the trends in average (median) house price, we have found that the average has increased across England and Wales but much more rapidly in London and its surrounding area. It is particularly in the last decade that the average house price in London has seen a large spike. Furthermore, the majority of London house prices are now falling within a range that has increased massively compared to the rest of the country.","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"XHYdAoEiDR"}],"key":"hoWA7iQmDl"}],"key":"esBnhSGdnC"}],"key":"TN10C2dfJI"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"About Me","url":"/","group":"About Me"}}},"domain":"http://localhost:3000"},"project":{"github":"https://github.com/dannycmd","id":"0f6d5d1e-e416-46a3-80ea-a6dccab1ef6b","thebe":{"binder":{"url":"https://mybinder.org/","provider":"github","repo":"https://github.com/dannycmd","ref":"HEAD"}},"thumbnail":"/build/cover-dde47569623d997a6d33d7dab01947db.jpg","exports":[],"bibliography":[],"title":"About Me","index":"aboutme","pages":[{"title":"Projects","level":1},{"slug":"housepricesvisualisation","title":"House Prices","description":"","date":"","thumbnail":"/build/EDADensityPlot-762c22be9aee1c62ccbfd91e164b194f.PNG","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}}},"actionData":null,"errors":null},"future":{"unstable_dev":false,"unstable_postcss":false,"unstable_tailwind":false,"v2_errorBoundary":false,"v2_headers":true,"v2_meta":true,"v2_normalizeFormMethod":true,"v2_routeConvention":true}};</script><script type="module" async="">import "/build/manifest-4C03D258.js";
import * as route0 from "/build/root-ZSMPVWLZ.js";
import * as route1 from "/build/routes/$-OW6NTZY2.js";
window.__remixRouteModules = {"root":route0,"routes/$":route1};

import("/build/entry.client-K6EYMIDZ.js");</script></body></html>